<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TK Suite ‚Äî Mail & Account Tools</title>

 <link rel="icon" type="image/png" href="logo.png" />
<link rel="preconnect" href="https://www.googleapis.com">
<link rel="preconnect" href="https://firestore.googleapis.com">
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDiwjp-OoPJ3VwC068gvhTJ3swdjFc8k5A",
      authDomain: "lockey-238c0.firebaseapp.com",
      projectId: "lockey-238c0",
      storageBucket: "lockey-238c0.firebasestorage.app",
      messagingSenderId: "1097009271087",
      appId: "1:1097009271087:web:0f5cd5b55c917bbe21d1da",
      measurementId: "G-PNCE5DYWQK"
    };
  </script>

  <style>
    /* === üé® B·∫ÆT ƒê·∫¶U N√ÇNG C·∫§P GIAO DI·ªÜN NEON 2025 === */
    :root{
      /* M√†u Neon M·ªõi */
      --green-500: #00ff9d; /* Xanh Neon */
      --green-600: #00e68e;
      --green-700: #00c77a;
      --green-glow: rgba(0, 255, 157, 0.4);
      --green-glow-strong: rgba(0, 255, 157, 0.7);
      
      --blue-accent: #00f0ff; /* Xanh Cyan Neon */
      --blue-glow: rgba(0, 240, 255, 0.3);
      --blue-glow-strong: rgba(0, 240, 255, 0.6);

      /* Ch·∫ø ƒë·ªô t·ªëi (M·∫∑c ƒë·ªãnh) */
      --bg: #010a19; /* N·ªÅn xanh ƒëen cyber */
      --bg-soft: #010a19;
      --fg: #e5f0ff; /* Ch·ªØ s√°ng */
      --muted: #88a0c2; /* Ch·ªØ m·ªù */
      --card: rgba(10, 20, 39, 0.85); /* Hi·ªáu ·ª©ng Glassmorphism */
      --line: rgba(0, 240, 255, 0.25); /* Vi·ªÅn Cyan m·ªù */
      --shadow-soft: 0 24px 60px rgba(0,0,0,0.9);
      
      --radius: 18px;
      --danger: #ff4d4d;
      --danger-soft: rgba(255, 77, 77, 0.15);
      --warning: #f9b500;
      --warning-soft: rgba(249, 181, 0, 0.15);
    }

    /* Ch·∫ø ƒë·ªô S√°ng (Vibrant) */
    body[data-theme="light"]{
      --bg: #f4f7fa; /* N·ªÅn x√°m r·∫•t nh·∫°t */
      --bg-soft: #f4f7fa;
      --fg: #111827; /* Ch·ªØ ƒëen */
      --muted: #6b7280; /* Ch·ªØ m·ªù */
      --card: #ffffff; /* Th·∫ª tr·∫Øng */
      --line: #dce3ed; /* Vi·ªÅn x√°m nh·∫°t */
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.05);

      --danger-soft: #fee2e2;
      --warning-soft: #ffedd5;
    }
    
    /* ƒê·ªìng b·ªô ch·∫ø ƒë·ªô S√°ng */
    body[data-theme="light"]{
      background: var(--bg-soft);
    }
    body[data-theme="light"] .app{
      background: var(--card);
      border-color: var(--line);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: none; /* B·ªè blur ·ªü ch·∫ø ƒë·ªô s√°ng */
    }
    body[data-theme="light"] .app::before{
      opacity: 0.1;
    }
    body[data-theme="light"] .card{
      background: var(--card);
      border-color: var(--line);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      backdrop-filter: none;
    }
    body[data-theme="light"] .card:hover{
      border-color: var(--green-500);
      box-shadow: 0 6px 15px var(--green-glow);
    }
    body[data-theme="light"] .card:hover::before{
      opacity: 0.2;
    }
    
    /* N√∫t ·ªü ch·∫ø ƒë·ªô s√°ng */
    body[data-theme="light"] .tab{
      background: #eef2f9; 
      color: var(--muted);
      border-color: transparent;
      text-shadow: none;
      box-shadow: none;
    }
    body[data-theme="light"] .tab[aria-selected="true"]{
      background: var(--green-500); /* ƒê·ªìng b·ªô m√†u Neon */
      color: #010a19; /* Ch·ªØ ƒëen */
      box-shadow: 0 4px 15px var(--green-glow);
    }
    body[data-theme="light"] .btn{
      background: var(--green-500);
      color: #010a19;
      box-shadow: 0 4px 15px var(--green-glow);
    }
    body[data-theme="light"] .btn.ghost{
      background: #ffffff;
      color: #334155;
      border-color: var(--line);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      text-shadow: none;
    }
    body[data-theme="light"] .btn.ghost:hover{
      border-color: #a0a0a0;
      box-shadow: none;
    }
    body[data-theme="light"] .icon-btn{
      background: #ffffff;
      color: #334155;
      border-color: var(--line);
      text-shadow: none;
    }
    body[data-theme="light"] .icon-btn:hover{
      border-color: var(--green-500);
      color: var(--green-500);
      box-shadow: 0 4px 12px var(--green-glow);
    }
    
    /* Input ·ªü ch·∫ø ƒë·ªô s√°ng */
    body[data-theme="light"] textarea,
    body[data-theme="light"] input[type="text"],
    body[data-theme="light"] input[type="number"],
    body[data-theme="light"] input[type="date"]{
      background: #ffffff;
      color: var(--fg);
      box-shadow: none;
      border-color: var(--line);
    }
    body[data-theme="light"] textarea:focus,
    body[data-theme="light"] input:focus{
      border-color: var(--green-500);
      box-shadow: 0 0 0 2px var(--green-glow);
    }
    
    /* Ti√™u ƒë·ªÅ & Badge ·ªü ch·∫ø ƒë·ªô s√°ng */
    body[data-theme="light"] .brand-title,
    body[data-theme="light"] .card-head h3,
    body[data-theme="light"] .label-title,
    body[data-theme="light"] .pill-main strong,
    body[data-theme="light"] .history-header-title {
      color: var(--fg);
      text-shadow: none;
    }
    body[data-theme="light"] .cloud-status,
    body[data-theme="light"] .badge,
    body[data-theme="light"] .acc-badge,
    body[data-theme="light"] .h-tag {
      background: #f1f5f9;
      color: var(--muted);
      border-color: var(--line);
      text-shadow: none;
    }
    body[data-theme="light"] .pill-radio{
      background: #ffffff;
      border-color: var(--line);
    }
    body[data-theme="light"] .pill-radio:hover{
      background: #f8fafc;
      border-color: var(--green-500);
    }
    
    /* Fix tab T√†i kho·∫£n ·ªü ch·∫ø ƒë·ªô s√°ng */
    body[data-theme="light"] .acc-item{
      background: #fafcff;
      border-color: var(--line);
      box-shadow: none;
    }
    body[data-theme="light"] .acc-head-btn{
      background: #ffffff;
    }
    body[data-theme="light"] .acc-head-btn:hover{
      background: #fcfdff;
    }
    body[data-theme="light"] .acc-user-row{
      background: #f4f7fa;
      border-color: var(--line);
    }
    body[data-theme="light"] .acc-badge-warning{
      background: var(--warning-soft);
      color: #f9b500;
      border-color: #fed7aa;
    }
    body[data-theme="light"] .acc-badge-error{
      background: var(--danger-soft);
      color: #ff4d4d;
      border-color: #fca5a5;
    }
    body[data-theme="light"] .acc-badge-expired{
      background: #e5e7eb;
      color: #4b5563;
      border-color: #d1d5db;
    }
    body[data-theme="light"] .h-item{
      background: #ffffff;
      border-color: var(--line);
      box-shadow: none;
    }
    body[data-theme="light"] .h-btn{
      background: rgba(0, 255, 157, 0.1);
    }
    body[data-theme="light"] .h-line1 { color: var(--fg); }
    body[data-theme="light"] .history-ta {
      background: #f9fafb;
      color: var(--fg);
      border-color: var(--line);
    }
    /* === K·∫æT TH√öC N√ÇNG C·∫§P GIAO DI·ªÜN === */


    *{box-sizing:border-box;}
    html,body{min-height:100%;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at 0% 0%, rgba(0, 240, 255, 0.2), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(0, 255, 157, 0.2), transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(0, 255, 157, 0.15), transparent 55%),
        var(--bg-soft);
      color:var(--fg);
      padding:16px 8px 32px;
    }

    .app{
      width:100%;
      max-width:430px;
      padding:16px 12px 24px;
      margin:16px auto 32px;
      border-radius:26px;
      background: rgba(10, 20, 39, 0.85); /* N·ªÅn glass */
      box-shadow:var(--shadow-soft);
      border: 1px solid var(--line);
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(12px); /* Hi·ªáu ·ª©ng blur */
      -webkit-backdrop-filter: blur(12px);
    }
    .app::before{
      content:"";
      position:absolute;
      inset:-120px;
      background:
        radial-gradient(circle at 10% 0%, rgba(0, 255, 157, 0.1), transparent 55%),
        radial-gradient(circle at 90% 10%, rgba(0, 240, 255, 0.1), transparent 55%);
      opacity:0.9;
      pointer-events:none;
      z-index:-1;
    }

    @media (min-width:768px){
      body{
        padding:32px 16px 48px;
      }
      .app{
        max-width:920px;
        padding:22px 20px 30px;
        border-radius:28px;
        margin:24px auto 40px;
      }
    }
    @media (min-width:1024px){
      .app{
        max-width:1100px;
        padding:26px 24px 34px;
      }
    }

    /* HEADER */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .topbar-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-box{
      width:36px;
      height:36px;
      border-radius:999px;
      overflow:hidden;
      box-shadow:0 0 20px rgba(0, 255, 157, 0.3);
      border:1px solid var(--green-500);
      background: #010a19;
      display:flex;
      align-items:center;
      justify-content:center;
      transform:translateY(0);
      transition:.2s transform ease,.2s box-shadow ease;
    }
    .logo-box img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .logo-box:hover{
      transform:translateY(-2px);
      box-shadow:0 0 30px var(--green-glow-strong);
    }
    .brand-title{
      font-size:17px;
      font-weight:800;
      letter-spacing:.03em;
      color:var(--fg);
      text-shadow: 0 0 5px var(--green-glow);
    }
    .brand-sub{
      font-size:11px;
      color:var(--muted);
    }

    .topbar-actions{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .icon-btn{
      width:34px;
      height:34px;
      border-radius:999px;
      border:1px solid var(--line);
      background: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:17px;
      cursor:pointer;
      transition:.2s transform ease,.2s box-shadow ease,.18s border-color ease,.18s background ease;
      color:var(--muted);
      text-shadow: 0 0 3px var(--blue-glow);
    }
    .icon-btn:hover{
      transform:translateY(-1px);
      border-color: var(--blue-accent);
      color: var(--blue-accent);
      box-shadow: 0 0 10px var(--blue-glow-strong);
      background: rgba(0, 240, 255, 0.1);
    }

    .btn{
      appearance:none;
      border-radius:999px;
      border:1px solid transparent;
      background: var(--green-500);
      color: #010a19; /* Ch·ªØ ƒëen cho n·ªïi b·∫≠t */
      padding:7px 12px;
      font-size:12px;
      font-weight:700; /* ƒê·∫≠m h∆°n */
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      white-space:nowrap;
      transition:.16s transform ease,.16s box-shadow ease,.16s background ease,.16s border-color ease,.16s opacity ease;
      box-shadow: 0 0 12px var(--green-glow);
    }
    .btn.small{padding:5px 10px;font-size:11px;}
    .btn:active{transform:translateY(1px);}
    .btn.full{width:100%;justify-content:center;}
    .btn.ghost{
      background: transparent;
      border-color: var(--line);
      color: var(--muted);
      box-shadow: none;
      font-weight: 600;
    }
    .btn.ghost:hover{
      border-color: var(--blue-accent);
      color: var(--blue-accent);
      box-shadow: 0 0 8px var(--blue-glow);
      background: rgba(0, 240, 255, 0.1);
      text-shadow: 0 0 3px var(--blue-glow);
    }
    .btn.danger{
      background: var(--danger);
      border-color: transparent;
      color: #ffffff;
      box-shadow: 0 0 12px rgba(255, 77, 77, 0.5);
    }

    .cloud-status{
      font-size:10px;
      color:var(--muted);
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--line);
      background: transparent;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .cloud-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background: var(--blue-accent);
      box-shadow: 0 0 8px var(--blue-glow-strong);
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:6px;
      margin-bottom:12px;
      overflow-x:auto;
      padding-bottom:4px;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{display:none;}

    .tab{
      appearance:none;
      border-radius:999px;
      border:1px solid var(--line);
      background: transparent;
      padding:6px 11px;
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow: none;
      transition:.18s transform ease,.18s box-shadow ease,.18s border-color ease,.18s background ease,.18s color ease;
    }
    .tab-icon{font-size:13px;}
    .tab[aria-selected="true"]{
      color: #010a19; /* Ch·ªØ ƒëen */
      border-color: transparent;
      background: var(--green-500);
      box-shadow: 0 0 15px var(--green-glow-strong);
      transform:translateY(-1px);
      font-weight: 700;
    }

    .panel{display:block;animation:panelIn .22s ease;}
    .panel[hidden]{display:none;}

    @keyframes panelIn{
      from{opacity:0;transform:translateY(6px);}
      to{opacity:1;transform:translateY(0);}
    }

    /* CARD */
    .card{
      background: var(--card);
      border-radius:var(--radius);
      border: 1px solid var(--line);
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      margin-bottom:12px;
      overflow:hidden;
      position:relative;
      transform:translateY(0);
      transition:.2s transform ease,.2s box-shadow ease,.2s border-color ease,.2s background ease;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 0 0, rgba(0, 255, 157, 0.1), transparent 55%);
      opacity:0;
      pointer-events:none;
      transition:.2s opacity ease;
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow: 0 0 25px var(--green-glow);
      border-color: var(--green-500);
    }
    .card:hover::before{opacity:1;}

    .card-head{
      padding:9px 11px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .card-head h3{
      margin:0;
      font-size:13px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
      color:var(--fg);
    }
    .card-body{padding:10px 11px 11px;}

    .badge{
      padding:3px 7px;
      border-radius:999px;
      border: 1px solid var(--line);
      font-size:10px;
      color:var(--muted);
      background: transparent;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .field{margin-bottom:8px;}
    .label{
      font-size:11px;
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
      color:var(--fg);
    }
    .label-title{
      font-size:12px;
      font-weight:600;
      color:var(--fg);
    }

    textarea,
    input[type="text"],
    input[type="number"],
    input[type="date"]{
      width:100%;
      border-radius:14px;
      border: 1px solid var(--line);
      padding:9px 11px;
      font-size:13px;
      font-family:inherit;
      background: rgba(0,0,0,0.2);
      color:var(--fg);
      outline:none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3) inset;
      transition:.16s border-color ease,.16s box-shadow ease,.16s background ease;
    }
    textarea::placeholder,
    input::placeholder{
      color: var(--muted);
    }
    textarea:focus,
    input:focus{
      border-color: var(--green-500);
      box-shadow: 0 0 0 2px var(--green-glow), 0 5px 15px rgba(0,0,0,0.3) inset;
      background: rgba(0, 15, 30, 0.3);
    }
    textarea{
      min-height:190px;
      resize:vertical;
      line-height:1.45;
    }

    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }

    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .pill-column{flex-direction:column;}
    .pill-radio{
      flex:1 1 auto;
      border-radius:999px;
      border: 1px solid var(--line);
      padding:7px 9px;
      display:flex;
      align-items:flex-start;
      gap:6px;
      cursor:pointer;
      font-size:11px;
      background: transparent;
      transition:.16s border-color ease,.16s background ease,.16s box-shadow ease;
    }
    .pill-radio input{
      margin-top:2px;
      accent-color: var(--green-500);
    }
    .pill-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .pill-main strong{font-size:11px;color:var(--fg);}
    .pill-main span{color:var(--muted);}
    .pill-radio:hover{
      border-color: var(--green-500);
      box-shadow: 0 0 10px var(--green-glow);
      background: rgba(0, 255, 157, 0.1);
    }

    .checkbox-inline{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      color:var(--muted);
    }
    .checkbox-inline input{accent-color:var(--green-500);}

    /* === üìê S·ª¨A L·ªñI LAYOUT K·∫æT QU·∫¢ === */
    .card-head.result-head{
      flex-direction: row; /* LU√îN LU√îN l√† 1 h√†ng */
      align-items: center; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
      gap: 8px;
    }
    .result-head{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:4px;
      width:100%;
    }
    .result-head-main{
      width: auto; /* B·ªè width 100% */
      flex: 1 1 auto; /* Cho ph√©p co gi√£n */
      display:flex;
      align-items:center;
      justify-content: flex-start; /* Kh√¥ng ƒë·∫©y n√∫t "L∆∞u" ra xa */
      gap: 8px; /* Th√™m kho·∫£ng c√°ch gi·ªØa c√°c m·ª•c */
    }
    .result-head-main-left{
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .result-head-main-left h3,
    .result-head-main-left .badge{
      white-space:nowrap;
    }
    .result-head-actions{
      width: auto; /* B·ªè width 100% */
      flex: 0 0 auto; /* Kh√¥ng co gi√£n, gi·ªØ k√≠ch th∆∞·ªõc */
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-end;
      gap:6px;
      margin-top: 0; /* B·ªè margin top */
    }
    /* === K·∫æT TH√öC S·ª¨A LAYOUT === */


    /* HISTORY overlay */
    .history-overlay{
      position:fixed;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:14px 10px;
      opacity:0;
      pointer-events:none;
      transition:.18s opacity ease;
      z-index:50;
    }
    .history-overlay.open{
      opacity:1;
      pointer-events:auto;
    }
    .history-backdrop{
      position:absolute;
      inset:0;
      background:rgba(1, 10, 25, 0.75);
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
    }
    .history-sheet{
      position:relative;
      width:100%;
      max-width:430px;
      border-radius:20px;
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow:0 24px 70px rgba(0,0,0,0.95);
      max-height:calc(100vh - 40px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      animation:panelIn .2s ease;
    }

    @media (min-width:768px){
      .history-overlay{
        align-items:center;
        padding:22px 16px;
      }
      .history-sheet{
        max-width:780px;
        max-height:calc(100vh - 80px);
      }
    }
    @media (min-width:1024px){
      .history-sheet{
        max-width:980px;
      }
    }

    .history-header{
      padding:8px 11px 6px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .history-header-title{
      font-size:13px;
      font-weight:700;
      color:var(--fg);
    }
    .history-header-sub{
      font-size:11px;
      color:var(--muted);
    }
    .history-actions{
      padding:6px 10px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
    }
    .history-actions-right{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-end;
    }

    .history-list{
      padding:8px 10px 10px;
      overflow:auto;
      flex:1 1 auto;
    }
    .history-empty{
      font-size:12px;
      color:var(--muted);
    }
    .h-item{
      border-radius:14px;
      border: 1px solid var(--line);
      margin-bottom:8px;
      overflow:hidden;
      background: rgba(0,0,0,0.2);
      box-shadow:0 10px 26px rgba(0,0,0,0.7);
    }
    .h-btn{
      width:100%;
      text-align:left;
      border:none;
      background: rgba(0, 255, 157, 0.1);
      padding:7px 9px;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .h-main{
      display:flex;
      flex-direction:column;
      gap:2px;
      flex:1;
      min-width:0;
    }
    .h-line1{font-size:12px;font-weight:600;color:var(--fg);}
    .h-line2{
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .h-tag{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border: 1px solid var(--line);
      background: transparent;
      color:var(--muted);
    }
    .h-body{
      display:none;
      padding:8px 9px 9px;
      border-top: 1px solid var(--line);
    }
    .h-cols{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .history-ta{
      width:100%;
      min-height:70px;
      resize:vertical;
      border-radius:10px;
      border: 1px solid var(--line);
      padding:7px 8px;
      font-size:11px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      background: rgba(0,0,0,0.2);
      color:var(--fg);
    }
    
    /* ‚≠êÔ∏è M·ªöI: CSS cho 4 n√∫t l·ªãch s·ª≠ */
    .h-body-actions{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }

    /* TOAST */
    #toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: var(--green-500);
      color: #010a19;
      padding:7px 16px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      box-shadow: 0 0 20px var(--green-glow-strong);
      opacity:0;
      transition:.18s opacity ease,.18s transform ease;
      z-index:60;
      pointer-events:none;
    }
    #toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }

    /* ACCOUNT MANAGER */
    .acc-form-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .acc-users{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .acc-user-row{
      padding:6px 8px;
      border-radius:12px;
      border: 1px dashed var(--line);
      background: rgba(0,0,0,0.2);
    }
    .acc-user-row-title{
      font-size:11px;
      font-weight:600;
      margin-bottom:4px;
      color:var(--fg);
    }
    .acc-list-empty{
      font-size:12px;
      color:var(--muted);
    }
    .acc-item{
      border-radius:14px;
      border: 1px solid var(--line);
      margin-bottom:8px;
      overflow:hidden;
      background: rgba(0,0,0,0.2);
      box-shadow:0 14px 36px rgba(0,0,0,0.7);
    }
    .acc-head-btn{
      width:100%;
      text-align:left;
      border:none;
      background: transparent;
      padding:8px 9px;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition: .15s background ease;
    }
    .acc-head-btn:hover{
      background: rgba(0, 240, 255, 0.05);
    }
    .acc-title{
      font-size:12px;
      font-weight:600;
      color:var(--fg);
    }
    .acc-sub{
      font-size:11px;
      color:var(--muted);
    }
    .acc-badges{
      margin-left:auto;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      font-size:10px;
      align-items:center;
    }
    .acc-badge{
      padding:2px 6px;
      border-radius:999px;
      border: 1px solid var(--line);
      background: transparent;
      color:var(--muted);
    }
    .acc-badge-warning{
      background: var(--warning-soft);
      color: var(--warning);
      border-color: var(--warning);
      text-shadow: 0 0 5px var(--warning-soft);
    }
    .acc-badge-error{
      background: var(--danger-soft);
      color: var(--danger);
      border-color: var(--danger);
      text-shadow: 0 0 5px var(--danger-soft);
    }
    .acc-badge-expired{
      background: rgba(136, 160, 194, 0.1);
      color: var(--muted);
      border-color: var(--muted);
    }
    .acc-countdown{
      font-size:11px;
      color:var(--muted);
      margin-left:4px;
    }
    .acc-body{
      display:none;
      padding:8px 9px 9px;
      border-top: 1px solid var(--line);
    }
    .acc-body-grid{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .acc-body-actions{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .pill-inline{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      color:var(--muted);
    }

    /* RESPONSIVE PANELS: 2 C·ªòT TR√äN PC */
    @media (min-width:900px){
      .panel:not([hidden]){
        display:grid;
        grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
        gap:12px;
        align-items:flex-start;
      }
      .panel:not([hidden]) .card{
        margin-bottom:0;
      }
    }
  </style>
</head>
<body data-theme="dark">
<div class="app">
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo-box">
  <img src="logo.png" alt="Logo">
</div>
      <div>
        <div class="brand-title">TK Suite</div>
        <div class="brand-sub">Mail ‚Ä¢ Key ‚Ä¢ T√†i kho·∫£n</div>
      </div>
    </div>
    <div class="topbar-actions">
      <span class="cloud-status" id="cloudStatus">
  <span class="cloud-dot"></span> Cloud: ƒëang k·∫øt n·ªëi‚Ä¶
</span>
      <button class="icon-btn" id="btnToggleTheme" title="Dark / Light">üåô</button>
      <button class="btn ghost small" id="toggleHistoryBtn">L·ªãch s·ª≠</button>
    </div>
  </header>

  <div class="tabs">
    <button class="tab" id="tabAccounts" aria-selected="true">
      <span class="tab-icon">üë•</span>T√†i kho·∫£n
    </button>
    <button class="tab" id="tabCleaner" aria-selected="false">
      <span class="tab-icon">‚úâÔ∏è</span>Cleaner
    </button>
    <button class="tab" id="tabScan" aria-selected="false">
      <span class="tab-icon">üß™</span>Scan
    </button>
    <button class="tab" id="tabKey" aria-selected="false">
      <span class="tab-icon">üîë</span>Add Link
    </button>
  </div>

  <section class="panel" id="panelAccounts">
    <div class="card">
      <div class="card-head">
        <h3>Th√™m / s·ª≠a t√†i kho·∫£n</h3>
      </div>
      <div class="card-body">
        <div class="field">
          <div class="label"><span>T√†i kho·∫£n *</span></div>
          <input type="text" id="acc_account" placeholder="Nh·∫≠p t√™n t√†i kho·∫£n..." />
        </div>

        <div class="field">
          <div class="label"><span>S·ªë ng√†y c√≤n *</span></div>
          <input type="number" id="acc_days" min="0" placeholder="VD: 30" />
        </div>

        <div class="field">
          <div class="label">
            <span>Ng∆∞·ªùi d√πng & thi·∫øt b·ªã (t·ªëi ƒëa 3)</span>
          </div>
          <div class="acc-users" id="acc_usersContainer"></div>
          <button class="btn ghost small" id="acc_addUserBtn" style="margin-top:6px;">+ Th√™m ng∆∞·ªùi d√πng</button>
        </div>

        <div class="acc-form-actions">
          <button class="btn full" id="acc_saveBtn">L∆∞u t√†i kho·∫£n</button>
          <button class="btn ghost full" id="acc_clearFormBtn">Xo√° form</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <h3>Danh s√°ch t√†i kho·∫£n</h3>
      </div>
      <div class="card-body" id="acc_list">
        <div class="acc-list-empty">Ch∆∞a c√≥ t√†i kho·∫£n n√†o.</div>
      </div>
    </div>
  </section>

  <section class="panel" id="panelCleaner" hidden>
    <div class="card">
      <div class="card-head">
        <h3>Mail Cleaner</h3>
      </div>
      <div class="card-body">
        <div class="field">
          <div class="row" style="justify-content:space-between;">
            <span class="label-title">Input</span>
            <div class="row" style="flex:0 0 auto;">
              <label class="btn ghost small" for="cl_fileInput">Ch·ªçn file .txt</label>
              <button class="btn ghost small" id="cl_resetBtn">Reset</button>
              <input id="cl_fileInput" type="file" accept=".txt,text/plain" hidden />
            </div>
          </div>
        </div>

        <div class="field">
          <textarea id="cl_inputArea" class="mono" placeholder="D√°n danh s√°ch mail ·ªü ƒë√¢y..."></textarea>
        </div>

        <div class="field">
          <div class="row">
            <label class="checkbox-inline">
              <input id="cl_dedupe" type="checkbox" checked />
              <span>Xo√° tr√πng</span>
            </label>
            <label class="checkbox-inline">
              <input id="cl_treatEscapedNewlines" type="checkbox" />
              <span>\\n ‚Üí xu·ªëng d√≤ng</span>
            </label>
          </div>
        </div>

        <div class="field">
          <div class="label"><span>Ki·ªÉu xu·∫•t</span></div>
          <div class="pill-row">
            <label class="pill-radio">
              <input type="radio" name="cl_outMode" value="email" checked />
              <div class="pill-main">
                <strong>Ch·ªâ email</strong>
                <span class="mono" style="font-size:10px;">mail@example.com</span>
              </div>
            </label>
            <label class="pill-radio">
              <input type="radio" name="cl_outMode" value="emailPass" />
              <div class="pill-main">
                <strong>Email | Pass</strong>
                <span class="mono" style="font-size:10px;">mail@example.com|m·∫≠t_kh·∫©u</span>
              </div>
            </label>
          </div>
        </div>

        <button class="btn full" id="cl_processBtn">Process</button>
      </div>
    </div>

    <div class="card">
      <div class="card-head result-head">
        <div class="result-head-main">
          <div class="result-head-main-left">
            <h3>K·∫øt qu·∫£</h3>
            <span class="badge" id="cl_statBadge">0 d√≤ng ‚Üí 0 out</span>
          </div>
        </div>
        <div class="result-head-actions">
          <button class="btn ghost small" id="cl_selectBtn">all</button>
          <button class="btn ghost small" id="cl_copyBtn">Copy</button>
          <button class="btn ghost small" id="cl_saveHistoryBtn">L∆∞u</button>
          <button class="btn ghost small" id="cl_downloadBtn">T·∫£i .txt</button>
        </div>
      </div>
      <div class="card-body">
        <textarea id="cl_resultTA" class="mono" placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..." readonly></textarea>
      </div>
    </div>
  </section>

  <section class="panel" id="panelScan" hidden>
    <div class="card">
      <div class="card-head">
        <h3>Scan / Format</h3>
      </div>
      <div class="card-body">
        <div class="field">
          <div class="row" style="justify-content:space-between;">
            <span class="label-title">Input</span>
            <div class="row" style="flex:0 0 auto;">
              <label class="btn ghost small" for="sc_fileInput">Ch·ªçn file .txt</label>
              <button class="btn ghost small" id="sc_resetBtn">Reset</button>
              <input id="sc_fileInput" type="file" accept=".txt,text/plain" hidden />
            </div>
          </div>
        </div>

        <div class="field">
          <textarea id="sc_inputArea" class="mono" placeholder="M·ªói d√≤ng 1 mail..."></textarea>
        </div>

        <div class="field">
          <div class="label"><span>Ki·ªÉu format</span></div>
          <div class="pill-row">
            <label class="pill-radio">
              <input type="radio" name="sc_fmt" value="1" checked />
              <div class="pill-main">
                <strong>mail|xincamon</strong>
                <span class="mono" style="font-size:10px;">mail@example.com|xincamon</span>
              </div>
            </label>
            <label class="pill-radio">
              <input type="radio" name="sc_fmt" value="2" />
              <div class="pill-main">
                <strong>T√†i kho·∫£n | M·∫≠t kh·∫©u</strong>
                <span class="mono" style="font-size:10px;">T√†i kho·∫£n:mail|M·∫≠t kh·∫©u:xincamon</span>
              </div>
            </label>
          </div>
        </div>

        <button class="btn full" id="sc_processBtn">Process</button>
      </div>
    </div>

    <div class="card">
      <div class="card-head result-head">
        <div class="result-head-main">
          <div class="result-head-main-left">
            <h3>K·∫øt qu·∫£</h3>
            <span class="badge" id="sc_stat">0 d√≤ng</span>
          </div>
        </div>
        <div class="result-head-actions">
          <button class="btn ghost small" id="sc_selectAllOut">all</button>
          <button class="btn ghost small" id="sc_copyAllOut">Copy</button>
          <button class="btn ghost small" id="sc_saveHistoryBtn">L∆∞u</button>
          <button class="btn ghost small" id="sc_downloadBtn">T·∫£i .txt</button>
        </div>
      </div>
      <div class="card-body">
        <textarea id="sc_resultTA" class="mono" readonly placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."></textarea>
      </div>
    </div>
  </section>

  <section class="panel" id="panelKey" hidden>
    <div class="card">
      <div class="card-head">
        <div class="row" style="justify-content:flex-start;gap:6px;">
          <button class="btn ghost small" id="lk_linkToggleBtn">Link nh·∫≠p key</button>
          <h3>Add Link Nh·∫≠p Key</h3>
        </div>
      </div>
      <div class="card-body">
        <div class="field" id="lk_linkPanel" style="display:none;">
          <div class="label">
            <span>Link nh·∫≠p key</span>
          </div>
          <div class="row" style="width:100%;gap:6px;">
            <input id="lk_linkInput" type="text" placeholder="https://nhapkey.click ho·∫∑c nhapkey.click" />
            <button class="btn ghost small" id="lk_saveLinkBtn">L∆∞u</button>
          </div>
        </div>

        <div class="field">
          <div class="label">
            <span>N·∫°p file key (.txt)</span>
          </div>
          <div class="row">
            <label class="btn ghost small" for="lk_fileInput">Ch·ªçn file .txt</label>
            <input id="lk_fileInput" type="file" accept=".txt,text/plain" hidden />
            <button class="btn ghost small" id="lk_resetBtn">Reset</button>
          </div>
        </div>

        <div class="field">
          <textarea id="lk_rawInput" class="mono" placeholder="Danh s√°ch key..."></textarea>
        </div>

        <div class="field">
          <div class="label"><span>T√πy ch·ªçn format</span></div>
          <div class="pill-row pill-column">
            <label class="pill-radio" data-option="opt1">
              <input type="radio" name="lk_format" value="opt1" checked />
              <div class="pill-main">
                <strong>T√πy ch·ªçn 1</strong>
                <span class="mono" style="font-size:10px;">KEY:m√£key|link nh·∫≠p key:link</span>
              </div>
            </label>
            <label class="pill-radio" data-option="opt2">
              <input type="radio" name="lk_format" value="opt2" />
              <div class="pill-main">
                <strong>T√πy ch·ªçn 2</strong>
                <span class="mono" style="font-size:10px;">m√£key|link nh·∫≠p key:link</span>
              </div>
            </label>
            <label class="pill-radio" data-option="opt3">
              <input type="radio" name="lk_format" value="opt3" />
              <div class="pill-main">
                <strong>T√πy ch·ªçn 3</strong>
                <span class="mono" style="font-size:10px;">m√£key</span>
              </div>
            </label>
          </div>
        </div>

        <button class="btn full" id="lk_processBtn">Process</button>

        <div class="row" style="margin-top:6px;">
          <span class="badge" id="lk_statLines">0 d√≤ng</span>
          <span class="badge" id="lk_statValid">0 key h·ª£p l·ªá</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-head result-head">
        <div class="result-head-main">
          <div class="result-head-main-left">
            <h3>K·∫øt qu·∫£</h3>
          </div>
        </div>
        <div class="result-head-actions">
          <button class="btn ghost small" id="lk_selectAllBtn">all</button>
          <button class="btn ghost small" id="lk_copyBtn">Copy</button>
          <button class="btn ghost small" id="lk_saveHistoryBtn">L∆∞u</button>
          <button class="btn ghost small" id="lk_downloadBtn">T·∫£i .txt</button>
        </div>
      </div>
      <div class="card-body">
        <textarea id="lk_output" class="mono" readonly placeholder="K·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y..."></textarea>
      </div>
    </div>
  </section>
</div>

<div class="history-overlay" id="historyPanel" aria-hidden="true">
  <div class="history-backdrop" id="panelBackdrop"></div>
  <div class="history-sheet">
    <div class="history-header">
      <div>
        <div class="history-header-title">L·ªãch s·ª≠</div>
        <div class="history-header-sub">Theo t·ª´ng tab: Cleaner, Scan, Add Link</div>
      </div>
      <button class="btn ghost small" id="closePanelBtn">ƒê√≥ng</button>
    </div>
    <div class="history-actions">
      <div class="history-actions-right">
        <button class="btn ghost small" id="btnPullCloud">T·∫£i t·ª´ cloud</button>
        <button class="btn ghost small" id="btnPushCloud">ƒê·ªìng b·ªô l√™n cloud</button>
        <button class="btn danger small" id="clearHistoryBtn">Xo√° l·ªãch s·ª≠ tab hi·ªán t·∫°i</button>
      </div>
    </div>
    <div class="history-list" id="historyList"></div>
  </div>
</div>

<div id="toast"></div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  /* TOAST */
  const toastEl = $('#toast');
  let toastTimeout = null;
  function showToast(msg){
    if(!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    if(toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(()=>{
      toastEl.classList.remove('show');
    }, 1800);
  }

  /* ‚≠êÔ∏è FIX 2: H√ÄM COPY "M·∫†NH NH·∫§T" (d√πng execCommand)
    H√†m n√†y s·∫Ω ho·∫°t ƒë·ªông 100% ngay c·∫£ khi ch·∫°y file t·ª´ content:// (kh√¥ng an to√†n)
  */
  function robustCopy(textareaElement) {
    const val = textareaElement.value || '';
    if (!val) {
      showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ copy');
      return;
    }
    
    const isReadonly = textareaElement.readOnly;
    if (isReadonly) {
      textareaElement.readOnly = false;
    }

    textareaElement.select();
    textareaElement.setSelectionRange(0, 999999); // D√†nh cho di ƒë·ªông

    try {
      document.execCommand('copy');
      showToast('ƒê√£ copy k·∫øt qu·∫£');
    } catch (e) {
      showToast('Kh√¥ng copy ƒë∆∞·ª£c, h√£y Ctrl+A r·ªìi Ctrl+C');
    }
    
    if (isReadonly) {
      textareaElement.readOnly = true;
    }
    
    // B·ªè ch·ªçn (deselect)
    if (window.getSelection) {
      window.getSelection().removeAllRanges();
    } else if (document.selection) {
      document.selection.empty();
    }
  }

  /* THEME */
  const themeBtn = $('#btnToggleTheme');
  function applyTheme(theme){
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem('tk_theme', theme);
    if(themeBtn){
      themeBtn.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }
  }
  (function initTheme(){
    const saved = localStorage.getItem('tk_theme') || 'dark';
    applyTheme(saved);
  })();
  if(themeBtn){
    themeBtn.addEventListener('click', ()=>{
      const cur = document.body.getAttribute('data-theme') || 'dark';
      applyTheme(cur === 'dark' ? 'light' : 'dark');
    });
  }

  /* TABS ‚Äì nh·ªõ default l√† accounts */
  const tabs = {
    accounts: {btn: $('#tabAccounts'), panel: $('#panelAccounts')},
    cleaner: {btn: $('#tabCleaner'), panel: $('#panelCleaner')},
    scan: {btn: $('#tabScan'), panel: $('#panelScan')},
    key: {btn: $('#tabKey'), panel: $('#panelKey')}
  };
  let currentTab = localStorage.getItem('tk_currentTab') || 'accounts';

  function setTab(name){
    currentTab = name;
    localStorage.setItem('tk_currentTab', name);
    Object.entries(tabs).forEach(([key, val])=>{
      if(!val.btn || !val.panel) return;
      const active = key === name;
      val.btn.setAttribute('aria-selected', active ? 'true' : 'false');
      val.panel.hidden = !active;
    });
    if(name === 'accounts'){
      renderAccountList();
    }
  }

  Object.entries(tabs).forEach(([key, val])=>{
    if(val.btn){
      val.btn.addEventListener('click', ()=>setTab(key));
    }
  });
  setTab(currentTab);

  /* HISTORY local */
  const HISTORY_KEY = 'tk_history_v1';
  function loadHistoryMap(){
    try{
      const raw = localStorage.getItem(HISTORY_KEY);
      if(!raw) return {cleaner:[], scan:[], key:[]};
      const obj = JSON.parse(raw);
      return {
        cleaner: obj.cleaner || [],
        scan: obj.scan || [],
        key: obj.key || []
      };
    }catch(e){
      return {cleaner:[], scan:[], key:[]};
    }
  }
  function saveHistoryMap(map){
    localStorage.setItem(HISTORY_KEY, JSON.stringify(map));
  }
  function addHistory(type, payload){
    const map = loadHistoryMap();
    const list = map[type] || [];
    const entry = {
      id: 'h_'+Date.now()+'_'+Math.random().toString(16).slice(2),
      ts: Date.now(),
      ...payload
    };
    list.unshift(entry);
    map[type] = list.slice(0, 100);
    saveHistoryMap(map);
    showToast('ƒê√£ l∆∞u v√†o l·ªãch s·ª≠');
  }

  /* FIREBASE / CLOUD */
/* FIREBASE / CLOUD */
let db = null;
let firebaseReady = false;


function setCloudStatus(text) {
  // L·∫•y element M·ªñI KHI H√ÄM ƒê∆Ø·ª¢C G·ªåI
  const cloudStatusEl = $('#cloudStatus'); 
  
  if (!cloudStatusEl) {
    // N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, b√°o l·ªói ƒë·ªÉ b·∫°n bi·∫øt
    console.warn('L·ªñI: Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ #cloudStatus');
    return;
  }
  
  cloudStatusEl.innerHTML = `<span class="cloud-dot"></span> ${text}`;
}


async function initFirebase() {
  try {
    // 1) V·ª´a v√†o l√† b√°o ƒëang kh·ªüi t·∫°o lu√¥n (cho c·∫£m gi√°c nhanh)
    setCloudStatus('Cloud: OK (ƒëang kh·ªüi t·∫°o‚Ä¶)');

    // 2) Kh·ªüi t·∫°o Firebase
    firebase.initializeApp(firebaseConfig);

    // 3) Kh·ªüi t·∫°o Firestore c√†ng s·ªõm c√†ng t·ªët
    db = firebase.firestore();
    db.settings({
      cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
      experimentalForceLongPolling: true // √©p long-polling cho tab ·∫©n danh / mobile
    });

    // ‚úÖ ƒê√°nh d·∫•u ƒë√£ s·∫µn s√†ng NGAY SAU KHI C√ì FIRESTORE
    firebaseReady = true;
    setCloudStatus('Cloud: OK');

    // 4) ƒêƒÉng nh·∫≠p ·∫©n danh ch·∫°y n·ªÅn, kh√¥ng ch·∫∑n firebaseReady
    firebase.auth().signInAnonymously().catch(e => {
      console.warn('Firebase auth failed', e);
      // Kh√¥ng t·∫Øt firebaseReady ƒë·ªÉ v·∫´n th·ª≠ sync ƒë∆∞·ª£c
      if (e.code === 'auth/unauthorized-domain') {
        showToast('L·ªñI: Domain ch∆∞a ƒë∆∞·ª£c ·ªßy quy·ªÅn. H√£y th√™m domain n√†y v√†o Firebase Authentication.');
        setCloudStatus('Cloud: l·ªói auth (domain)');
      } else {
        showToast('L·ªói ƒëƒÉng nh·∫≠p Firebase');
        setCloudStatus('Cloud: l·ªói auth');
      }
    });

  } catch (e) {
    console.warn('Firebase init failed', e);
    firebaseReady = false;
    setCloudStatus('Cloud: l·ªói init');
    showToast('L·ªói kh·ªüi t·∫°o Firebase');
  }
}

  const getHistoryDocRef = () => db.collection('lockey_suite').doc('history');

  async function syncHistoryFromCloud(){
    if(!firebaseReady || !db){
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: ch∆∞a s·∫µn s√†ng';
      showToast('Firebase ch∆∞a s·∫µn s√†ng. ƒê·∫£m b·∫£o domain ƒë√£ ƒë∆∞·ª£c ·ªßy quy·ªÅn.');
      return;
    }
    try{
      const snap = await getHistoryDocRef().get();
      if(snap.exists){
        const data = snap.data() || {};
        const map = {
          cleaner: data.cleaner || [],
          scan: data.scan || [],
          key: data.key || []
        };
        saveHistoryMap(map);
        showToast('ƒê√£ t·∫£i l·ªãch s·ª≠ t·ª´ cloud');
        if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: OK';
        renderHistoryFor(currentTab);
      }else{
        showToast('Cloud ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠');
        if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: OK (tr·ªëng)';
      }
    }catch(e){
      console.warn('syncHistoryFromCloud error', e);
      showToast('L·ªói ƒë·ªçc l·ªãch s·ª≠ t·ª´ cloud');
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: l·ªói ƒë·ªçc l·ªãch s·ª≠';
    }
  }

  async function syncHistoryToCloud(){
    if(!firebaseReady || !db){
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: ch∆∞a s·∫µn s√†ng';
      showToast('Firebase ch∆∞a s·∫µn s√†ng. ƒê·∫£m b·∫£o domain ƒë√£ ƒë∆∞·ª£c ·ªßy quy·ªÅn.');
      return;
    }
    try{
      const map = loadHistoryMap();
      await getHistoryDocRef().set(map);
      showToast('ƒê√£ ƒë·ªìng b·ªô l·ªãch s·ª≠ l√™n cloud');
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: OK';
    }catch(e){
      console.warn('syncHistoryToCloud error', e);
      showToast('L·ªói ghi l·ªãch s·ª≠ l√™n cloud');
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: l·ªói ghi l·ªãch s·ª≠';
    }
  }

  initFirebase();

  /* ‚≠êÔ∏è M·ªöI: C·∫ßn tham chi·∫øu ƒë·∫øn c√°c input n√†y cho n√∫t "N·∫°p v√†o tab" */
  const cl_inputArea = $('#cl_inputArea');
  const sc_inputArea = $('#sc_inputArea');
  const lk_rawInput = $('#lk_rawInput');
  
  /* HISTORY UI */
  const historyPanel = $('#historyPanel');
  const historyListEl = $('#historyList');

  function formatTs(ts){
    try{
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      return `${dd}/${mm}/${yy} ${hh}:${mi}:${ss}`;
    }catch(e){
      return '';
    }
  }

  function renderHistoryFor(tab){
    if(!historyListEl) return;
    const map = loadHistoryMap();
    const list = map[tab] || [];
    if(!list.length){
      historyListEl.innerHTML = '<div class="history-empty">Ch∆∞a c√≥ l·ªãch s·ª≠ cho tab n√†y.</div>';
      return;
    }
    historyListEl.innerHTML = '';
    list.forEach(item=>{
      const div = document.createElement('div');
      div.className = 'h-item';
      
      /* ‚≠êÔ∏è M·ªöI: Th√™m 4 n√∫t v√† class cho textarea */
      div.innerHTML = `
        <button class="h-btn" type="button">
          <div class="h-main">
            <div class="h-line1">${item.title || item.label || 'L·ªãch s·ª≠'}</div>
            <div class="h-line2">${formatTs(item.ts)} ‚Ä¢ ${item.meta || ''}</div>
          </div>
          <span class="h-tag">${tab}</span>
        </button>
        <div class="h-body">
          <div class="h-cols">
            <div>
              <div class="label"><span>Input</span></div>
              <textarea class="history-ta mono history-ta-input" readonly>${item.input || ''}</textarea>
            </div>
            <div>
              <div class="label"><span>K·∫øt qu·∫£</span></div>
              <textarea class="history-ta mono history-ta-output" readonly>${item.output || ''}</textarea>
            </div>
          </div>
          <div class="h-body-actions">
            <button class="btn ghost small" data-act="copy-input">Copy Input</button>
            <button class="btn ghost small" data-act="copy-output">Copy Output</button>
            <button class="btn ghost small" data-act="load-tab">N·∫°p v√†o tab</button>
            <button class="btn danger small" data-act="delete-item">Xo√° l√¥</button>
          </div>
        </div>
      `;
      
      const btn = div.querySelector('.h-btn');
      const body = div.querySelector('.h-body');
      btn.addEventListener('click', ()=>{
        body.style.display = body.style.display === 'block' ? 'none' : 'block';
      });
      
      /* ‚≠êÔ∏è M·ªöI: Th√™m event listener cho 4 n√∫t */
      const taInput = div.querySelector('.history-ta-input');
      const taOutput = div.querySelector('.history-ta-output');
      const btnCopyIn = div.querySelector('[data-act="copy-input"]');
      const btnCopyOut = div.querySelector('[data-act="copy-output"]');
      const btnLoad = div.querySelector('[data-act="load-tab"]');
      const btnDelete = div.querySelector('[data-act="delete-item"]');

      if (btnCopyIn && taInput) {
        btnCopyIn.addEventListener('click', () => robustCopy(taInput));
      }
      if (btnCopyOut && taOutput) {
        btnCopyOut.addEventListener('click', () => robustCopy(taOutput));
      }
      if (btnLoad) {
        btnLoad.addEventListener('click', () => {
          const inputArea = (tab === 'cleaner') ? cl_inputArea : 
                            (tab === 'scan') ? sc_inputArea : lk_rawInput;
          if (inputArea) {
            inputArea.value = item.input || '';
            setTab(tab);
            closeHistoryPanel();
            showToast('ƒê√£ n·∫°p d·ªØ li·ªáu v√†o tab');
          }
        });
      }
      if (btnDelete) {
        btnDelete.addEventListener('click', () => {
          if (!confirm('Xo√° m·ª•c l·ªãch s·ª≠ n√†y?')) return;
          const map = loadHistoryMap();
          const list = map[tab] || [];
          map[tab] = list.filter(i => i.id !== item.id);
          saveHistoryMap(map);
          renderHistoryFor(tab); // T·∫£i l·∫°i danh s√°ch
          showToast('ƒê√£ xo√° m·ª•c');
        });
      }
      
      historyListEl.appendChild(div);
    });
  }

  const toggleHistoryBtn = $('#toggleHistoryBtn');
  const closePanelBtn = $('#closePanelBtn');
  const panelBackdrop = $('#panelBackdrop');
  const btnPullCloud = $('#btnPullCloud');
  const btnPushCloud = $('#btnPushCloud');
  const clearHistoryBtn = $('#clearHistoryBtn');

  function openHistoryPanel(){
    historyPanel.classList.add('open');
    historyPanel.setAttribute('aria-hidden','false');
    renderHistoryFor(currentTab);
  }
  function closeHistoryPanel(){
    historyPanel.classList.remove('open');
    historyPanel.setAttribute('aria-hidden','true');
  }

  if(toggleHistoryBtn) toggleHistoryBtn.addEventListener('click', openHistoryPanel);
  if(closePanelBtn) closePanelBtn.addEventListener('click', closeHistoryPanel);
  if(panelBackdrop) panelBackdrop.addEventListener('click', closeHistoryPanel);
  if(btnPullCloud) btnPullCloud.addEventListener('click', syncHistoryFromCloud);
  if(btnPushCloud) btnPushCloud.addEventListener('click', syncHistoryToCloud);
  if(clearHistoryBtn){
    clearHistoryBtn.addEventListener('click', ()=>{
      if(!confirm('Xo√° to√†n b·ªô l·ªãch s·ª≠ c·ªßa tab hi·ªán t·∫°i?')) return;
      const map = loadHistoryMap();
      map[currentTab] = [];
      saveHistoryMap(map);
      renderHistoryFor(currentTab);
      showToast('ƒê√£ xo√° l·ªãch s·ª≠ tab hi·ªán t·∫°i');
    });
  }

  /* CLEANER */
  const cl_resultTA = $('#cl_resultTA');
  const cl_dedupe = $('#cl_dedupe');
  const cl_treatEsc = $('#cl_treatEscapedNewlines');
  const cl_processBtn = $('#cl_processBtn');
  const cl_resetBtn = $('#cl_resetBtn');
  const cl_fileInput = $('#cl_fileInput');
  const cl_selectBtn = $('#cl_selectBtn');
  const cl_copyBtn = $('#cl_copyBtn');
  const cl_downloadBtn = $('#cl_downloadBtn');
  const cl_saveHistoryBtn = $('#cl_saveHistoryBtn');
  const cl_statBadge = $('#cl_statBadge');

  function parseEmailLine(line){
    const parts = line.split(/[|;, \t]+/).filter(Boolean);
    if(!parts.length) return {email:'', pass:''};
    let email = parts.find(p=>p.includes('@')) || parts[0];
    let pass = '';
    const idx = parts.indexOf(email);
    if(idx >= 0 && idx < parts.length-1){
      pass = parts[idx+1];
    }
    return {email:email.trim(), pass:pass.trim()};
  }

  function runCleaner(){
    if(!cl_inputArea || !cl_resultTA) return;
    let text = cl_inputArea.value || '';
    if(cl_treatEsc && cl_treatEsc.checked){
      text = text.replace(/\\n/g, '\n');
    }
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const inputCount = lines.length;

    const mode = (document.querySelector('input[name="cl_outMode"]:checked') || {}).value || 'email';
    const outSet = new Set();
    for(const line of lines){
      const {email, pass} = parseEmailLine(line);
      if(!email || !email.includes('@')) continue;
      let outLine = '';
      if(mode === 'email'){
        outLine = email;
      }else{
        outLine = `${email}${pass ? '|' + pass : ''}`;
      }
      if(!outLine) continue;
      if(cl_dedupe && cl_dedupe.checked){
        outSet.add(outLine);
      }else{
        outSet.add(outLine + '¬¶' + Math.random());
      }
    }
    let outLines = Array.from(outSet);
    if(cl_dedupe && cl_dedupe.checked){
      // gi·ªØ
    }else{
      outLines = outLines.map(s => s.split('¬¶')[0]);
    }
    const outputCount = outLines.length;
    cl_resultTA.value = outLines.join('\n');
    if(cl_statBadge){
      cl_statBadge.textContent = `${inputCount} d√≤ng ‚Üí ${outputCount} out`;
    }
  }

  if(cl_processBtn) cl_processBtn.addEventListener('click', runCleaner);

  if(cl_resetBtn){
    cl_resetBtn.addEventListener('click', ()=>{
      cl_inputArea.value = '';
      cl_resultTA.value = '';
      if(cl_statBadge) cl_statBadge.textContent = '0 d√≤ng ‚Üí 0 out';
    });
  }

  if(cl_fileInput){
    cl_fileInput.addEventListener('change', function(){
      const file = this.files && this.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        cl_inputArea.value = ev.target.result || '';
      };
      reader.onerror = function(){
        showToast('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file .txt');
      };
      reader.readAsText(file);
    });
  }

  if(cl_selectBtn){
    cl_selectBtn.addEventListener('click', ()=>{
      cl_resultTA.focus();
      cl_resultTA.select();
      showToast('ƒê√£ ch·ªçn to√†n b·ªô k·∫øt qu·∫£');
    });
  }

  // ‚≠êÔ∏è FIX 2: S·ª¨ D·ª§NG H√ÄM COPY M·ªöI
  if(cl_copyBtn){
    cl_copyBtn.addEventListener('click', () => robustCopy(cl_resultTA));
  }

  function downloadTextFile(filename, content){
    const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  if(cl_downloadBtn){
    cl_downloadBtn.addEventListener('click', ()=>{
      const val = cl_resultTA.value || '';
      if(!val){
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i');
        return;
      }
      downloadTextFile('cleaner_output.txt', val);
    });
  }

  if(cl_saveHistoryBtn){
    cl_saveHistoryBtn.addEventListener('click', ()=>{
      const input = cl_inputArea.value || '';
      const output = cl_resultTA.value || '';
      if(!output){
        showToast('Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ l∆∞u l·ªãch s·ª≠');
        return;
      }
      const meta = cl_statBadge ? cl_statBadge.textContent : '';
      addHistory('cleaner',{
        title:'Mail Cleaner',
        input,
        output,
        meta
      });
    });
  }

  /* SCAN */
  const sc_resultTA = $('#sc_resultTA');
  const sc_fileInput = $('#sc_fileInput');
  const sc_resetBtn = $('#sc_resetBtn');
  const sc_processBtn = $('#sc_processBtn');
  const sc_stat = $('#sc_stat');
  const sc_selectAllOut = $('#sc_selectAllOut');
  const sc_copyAllOut = $('#sc_copyAllOut');
  const sc_saveHistoryBtn = $('#sc_saveHistoryBtn');
  const sc_downloadBtn = $('#sc_downloadBtn');

  function runScan(){
    const raw = (sc_inputArea.value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const mode = (document.querySelector('input[name="sc_fmt"]:checked') || {}).value || '1';
    const out = [];
    for(const mail of raw){
      if(!mail.includes('@')) continue;
      if(mode === '1'){
        out.push(`${mail}|xincamon`);
      }else{
        out.push(`T√†i kho·∫£n:${mail}|M·∫≠t kh·∫©u:xincamon`);
      }
    }
    sc_resultTA.value = out.join('\n');
    if(sc_stat){
      sc_stat.textContent = `${out.length} d√≤ng`;
    }
  }

  if(sc_processBtn) sc_processBtn.addEventListener('click', runScan);

  if(sc_resetBtn){
    sc_resetBtn.addEventListener('click', ()=>{
      sc_inputArea.value = '';
      sc_resultTA.value = '';
      if(sc_stat) sc_stat.textContent = '0 d√≤ng';
    });
  }

  if(sc_fileInput){
    sc_fileInput.addEventListener('change', function(){
      const file = this.files && this.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        sc_inputArea.value = ev.target.result || '';
      };
      reader.onerror = function(){
        showToast('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file .txt');
      };
      reader.readAsText(file);
    });
  }

  if(sc_selectAllOut){
    sc_selectAllOut.addEventListener('click', ()=>{
      sc_resultTA.focus();
      sc_resultTA.select();
      showToast('ƒê√£ ch·ªçn to√†n b·ªô k·∫øt qu·∫£');
    });
  }

  // ‚≠êÔ∏è FIX 2: S·ª¨ D·ª§NG H√ÄM COPY M·ªöI
  if(sc_copyAllOut){
    sc_copyAllOut.addEventListener('click', () => robustCopy(sc_resultTA));
  }

  if(sc_saveHistoryBtn){
    sc_saveHistoryBtn.addEventListener('click', ()=>{
      const input = sc_inputArea.value || '';
      const output = sc_resultTA.value || '';
      if(!output){
        showToast('Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ l∆∞u l·ªãch s·ª≠');
        return;
      }
      const meta = sc_stat ? sc_stat.textContent : '';
      addHistory('scan',{
        title:'Scan / Format',
        input,
        output,
        meta
      });
    });
  }

  if(sc_downloadBtn){
    sc_downloadBtn.addEventListener('click', ()=>{
      const val = sc_resultTA.value || '';
      if(!val){
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i');
        return;
      }
      downloadTextFile('scan_output.txt', val);
    });
  }

  /* ADD LINK KEY */
  const lk_linkToggleBtn = $('#lk_linkToggleBtn');
  const lk_linkPanel = $('#lk_linkPanel');
  const lk_linkInput = $('#lk_linkInput');
  const lk_saveLinkBtn = $('#lk_saveLinkBtn');
  const lk_fileInput = $('#lk_fileInput');
  const lk_resetBtn = $('#lk_resetBtn');
  const lk_processBtn = $('#lk_processBtn');
  const lk_statLines = $('#lk_statLines');
  const lk_statValid = $('#lk_statValid');
  const lk_output = $('#lk_output');
  const lk_selectAllBtn = $('#lk_selectAllBtn');
  const lk_copyBtn = $('#lk_copyBtn');
  const lk_downloadBtn = $('#lk_downloadBtn');
  const lk_saveHistoryBtn = $('#lk_saveHistoryBtn');

  const LINK_KEY = 'tk_link_input';

  function initSavedLink(){
    const saved = localStorage.getItem(LINK_KEY) || '';
    if(lk_linkInput) lk_linkInput.value = saved;
  }
  initSavedLink();

  if(lk_linkToggleBtn && lk_linkPanel){
    lk_linkToggleBtn.addEventListener('click', ()=>{
      const show = lk_linkPanel.style.display !== 'block';
      lk_linkPanel.style.display = show ? 'block' : 'none';
    });
  }

  if(lk_saveLinkBtn){
    lk_saveLinkBtn.addEventListener('click', ()=>{
      const link = (lk_linkInput.value || '').trim();
      if(!link){
        showToast('Vui l√≤ng nh·∫≠p link');
        return;
      }
      localStorage.setItem(LINK_KEY, link);
      showToast('ƒê√£ l∆∞u link nh·∫≠p key');
    });
  }

  if(lk_fileInput){
    lk_fileInput.addEventListener('change', function(){
      const file = this.files && this.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        lk_rawInput.value = ev.target.result || '';
      };
      reader.onerror = function(){
        showToast('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file .txt');
      };
      reader.readAsText(file);
    });
  }

  if(lk_resetBtn){
    lk_resetBtn.addEventListener('click', ()=>{
      lk_rawInput.value = '';
      lk_output.value = '';
      if(lk_statLines) lk_statLines.textContent = '0 d√≤ng';
      if(lk_statValid) lk_statValid.textContent = '0 key h·ª£p l·ªá';
    });
  }

  function runAddLink(){
    const lines = (lk_rawInput.value || '').split(/\r?\n/).map(s=>s.trim());
    const total = lines.length;
    const linkRaw = (lk_linkInput.value || '').trim();
    const link = linkRaw || 'https://nhapkey.click';
    const fmt = (document.querySelector('input[name="lk_format"]:checked') || {}).value || 'opt1';
    const out = [];
    let valid = 0;
    for(const key of lines){
      if(!key) continue;
      valid++;
      let line = '';
      if(fmt === 'opt1'){
        line = `KEY:${key}|link nh·∫≠p key:${link}`;
      }else if(fmt === 'opt2'){
        line = `${key}|link nh·∫≠p key:${link}`;
      }else{
        line = key;
      }
      out.push(line);
    }
    lk_output.value = out.join('\n');
    if(lk_statLines) lk_statLines.textContent = `${total} d√≤ng`;
    if(lk_statValid) lk_statValid.textContent = `${valid} key h·ª£p l·ªá`;
  }

  if(lk_processBtn) lk_processBtn.addEventListener('click', runAddLink);

  if(lk_selectAllBtn){
    lk_selectAllBtn.addEventListener('click', ()=>{
      lk_output.focus();
      lk_output.select();
      showToast('ƒê√£ ch·ªçn to√†n b·ªô k·∫øt qu·∫£');
    });
  }

  // ‚≠êÔ∏è FIX 2: S·ª¨ D·ª§NG H√ÄM COPY M·ªöI
  if(lk_copyBtn){
    lk_copyBtn.addEventListener('click', () => robustCopy(lk_output));
  }

  if(lk_downloadBtn){
    lk_downloadBtn.addEventListener('click', ()=>{
      const val = lk_output.value || '';
      if(!val){
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i');
        return;
      }
      downloadTextFile('key_link_output.txt', val);
    });
  }

  if(lk_saveHistoryBtn){
    lk_saveHistoryBtn.addEventListener('click', ()=>{
      const input = lk_rawInput.value || '';
      const output = lk_output.value || '';
      if(!output){
        showToast('Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ l∆∞u l·ªãch s·ª≠');
        return;
      }
      const meta = `${lk_statLines ? lk_statLines.textContent : ''} ‚Ä¢ ${lk_statValid ? lk_statValid.textContent : ''}`;
      addHistory('key',{
        title:'Add Link Nh·∫≠p Key',
        input,
        output,
        meta
      });
    });
  }

  /* ACCOUNT MANAGER */
  const ACC_KEY = 'tk_accounts_v1';
  let accData = [];

  const acc_account = $('#acc_account');
  const acc_days = $('#acc_days');
  const acc_usersContainer = $('#acc_usersContainer');
  const acc_addUserBtn = $('#acc_addUserBtn');
  const acc_saveBtn = $('#acc_saveBtn');
  const acc_clearFormBtn = $('#acc_clearFormBtn');
  const acc_list = $('#acc_list');

  function loadAccounts(){
    try{
      const raw = localStorage.getItem(ACC_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }
  function saveAccounts(){
    localStorage.setItem(ACC_KEY, JSON.stringify(accData));
  }

  function newUserRow(user = {}){
    const wrap = document.createElement('div');
    wrap.className = 'acc-user-row';
    wrap.innerHTML = `
      <div class="acc-user-row-title">Ng∆∞·ªùi d√πng</div>
      <div class="field" style="margin-bottom:4px;">
        <input type="text" class="acc_user_name" placeholder="T√™n ng∆∞·ªùi d√πng" value="${user.name || ''}">
      </div>
      <div class="field" style="margin-bottom:4px;">
        <input type="text" class="acc_user_link" placeholder="Link ng∆∞·ªùi d√πng (tu·ª≥ ch·ªçn)" value="${user.link || ''}">
      </div>
      <div class="field" style="margin-bottom:0;">
        <input type="text" class="acc_user_device" placeholder="Thi·∫øt b·ªã (tu·ª≥ ch·ªçn)" value="${user.device || ''}">
      </div>
    `;
    return wrap;
  }

  function collectFormUsers(container){
    const rows = container.querySelectorAll('.acc-user-row');
    const arr = [];
    rows.forEach(row=>{
      const name = row.querySelector('.acc_user_name')?.value.trim() || '';
      const link = row.querySelector('.acc_user_link')?.value.trim() || '';
      const device = row.querySelector('.acc_user_device')?.value.trim() || '';
      if(name || link || device){
        arr.push({name, link, device});
      }
    });
    return arr.slice(0,3);
  }

  function calcDaysLeft(acc){
    if(!acc || !acc.expiresAt) return 0;
    const now = Date.now();
    const diff = acc.expiresAt - now;
    return Math.floor(diff / (24*60*60*1000));
  }

  function renderAccountList(){
    accData = loadAccounts();
    if(!acc_list) return;
    acc_list.innerHTML = '';
    if(!accData.length){
      acc_list.innerHTML = '<div class="acc-list-empty">Ch∆∞a c√≥ t√†i kho·∫£n n√†o.</div>';
      return;
    }

    accData.forEach(item=>{
      const daysLeft = calcDaysLeft(item);
      let status = item.status || 'active';
      if(status !== 'error'){
        if(daysLeft <= 0) status = 'expired';
        else if(daysLeft <= 2) status = 'warning';
        else status = 'active';
        item.status = status;
      }

      const wrap = document.createElement('div');
      wrap.className = 'acc-item';
      wrap.dataset.id = item.id;

      const headBtn = document.createElement('button');
      headBtn.type = 'button';
      headBtn.className = 'acc-head-btn';

      let subText = '';
      if(status === 'error'){
        subText = 'ƒêang l·ªói ‚Ä¢ ki·ªÉm tra l·∫°i';
      }else if(daysLeft > 0){
        subText = `C√≤n ${daysLeft} ng√†y`;
      }else if(daysLeft === 0){
        subText = 'H√¥m nay h·∫øt h·∫°n';
      }else{
        subText = `H·∫øt h·∫°n ${Math.abs(daysLeft)} ng√†y`;
      }

      headBtn.innerHTML = `
        <div>
          <div class="acc-title">${item.account}</div>
          <div class="acc-sub">
            ${subText}
            <span class="acc-countdown"></span>
          </div>
        </div>
        <div class="acc-badges">
          ${status === 'warning' ? '<span class="acc-badge acc-badge-warning">S·∫Øp h·∫øt h·∫°n</span>' : ''}
          ${status === 'error' ? '<span class="acc-badge acc-badge-error">L·ªói</span>' : ''}
          ${status === 'expired' && status !== 'error' ? '<span class="acc-badge acc-badge-expired">H·∫øt h·∫°n</span>' : ''}
        </div>
      `;

      if(item.expiresAt){
        headBtn.dataset.expTs = String(item.expiresAt);
      }

      const body = document.createElement('div');
      body.className = 'acc-body';

      const daysForInput = Math.max(calcDaysLeft(item), 0);

      const usersHTML = (item.users || []).map((u,idx)=>`
        <div class="acc-user-row">
          <div class="acc-user-row-title">Ng∆∞·ªùi d√πng ${idx+1}</div>
          <div class="field" style="margin-bottom:4px;">
            <input type="text" class="acc_user_name" placeholder="T√™n ng∆∞·ªùi d√πng" value="${u.name || ''}">
          </div>
          <div class="field" style="margin-bottom:4px;">
            <input type="text" class="acc_user_link" placeholder="Link ng∆∞·ªùi d√πng (tu·ª≥ ch·ªçn)" value="${u.link || ''}">
          </div>
          <div class="field" style="margin-bottom:0;">
            <input type="text" class="acc_user_device" placeholder="Thi·∫øt b·ªã (tu·ª≥ ch·ªçn)" value="${u.device || ''}">
          </div>
        </div>
      `).join('');

      body.innerHTML = `
        <div class="acc-body-grid">
          <div class="field">
            <div class="label"><span>T√†i kho·∫£n</span></div>
            <input type="text" class="acc_edit_account" value="${item.account || ''}" />
          </div>
          <div class="field">
            <div class="label"><span>S·ªë ng√†y c√≤n</span></div>
            <input type="number" class="acc_edit_days" min="0" value="${daysForInput}" />
          </div>
          <div class="field">
            <div class="label"><span>Ng∆∞·ªùi d√πng & thi·∫øt b·ªã</span></div>
            <div class="acc-users acc_edit_users">
              ${usersHTML || '<div class="acc-list-empty" style="margin-bottom:4px;">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o.</div>'}
            </div>
            <button class="btn ghost small" data-act="addUser">+ Th√™m ng∆∞·ªùi d√πng</button>
          </div>
        </div>
        <div class="acc-body-actions">
          <button class="btn ghost small" data-act="save">L∆∞u</button>
          <button class="btn danger small" data-act="error">ƒê√°nh d·∫•u l·ªói</button>
          <button class="btn ghost small" data-act="openUser">M·ªü link ng∆∞·ªùi d√πng</button>
          <button class="btn ghost small" data-act="delete">Xo√°</button>
        </div>
      `;

      headBtn.addEventListener('click', ()=>{
        const open = body.style.display === 'block';
        body.style.display = open ? 'none' : 'block';
      });

      body.addEventListener('click', e=>{
        const btn = e.target.closest('button[data-act]');
        if(!btn) return;
        const act = btn.dataset.act;
        const accId = item.id;
        const idx = accData.findIndex(a=>a.id === accId);
        if(idx < 0) return;

        if(act === 'addUser'){
          const container = body.querySelector('.acc_edit_users');
          const current = container.querySelectorAll('.acc-user-row').length;
          if(current >= 3){
            showToast('T·ªëi ƒëa 3 ng∆∞·ªùi d√πng.');
            return;
          }
          container.appendChild(newUserRow());
        }

        if(act === 'save'){
          const nameInput = body.querySelector('.acc_edit_account');
          const daysInput = body.querySelector('.acc_edit_days');
          const name = nameInput.value.trim();
          const days = parseInt(daysInput.value,10);
          if(!name){
            showToast('T√™n t√†i kho·∫£n kh√¥ng ƒë∆∞·ª£c tr·ªëng.');
            return;
          }
          if(isNaN(days) || days < 0){
            showToast('S·ªë ng√†y kh√¥ng h·ª£p l·ªá.');
            return;
          }
          const users = collectFormUsers(body.querySelector('.acc_edit_users'));
          const nowTs = Date.now();
          const expiresAt = nowTs + days*24*60*60*1000;
          accData[idx] = {
            ...accData[idx],
            account:name,
            users,
            expiresAt,
            status:(accData[idx].status === 'error' ? 'error' : 'active')
          };
          saveAccounts();
          showToast('ƒê√£ l∆∞u t√†i kho·∫£n');
          renderAccountList();
        }

        if(act === 'error'){
          accData[idx].status = 'error';
          saveAccounts();
          showToast('ƒê√£ ƒë√°nh d·∫•u l·ªói');
          renderAccountList();
        }

        if(act === 'delete'){
          if(!confirm('Xo√° t√†i kho·∫£n n√†y?')) return;
          accData.splice(idx,1);
          saveAccounts();
          showToast('ƒê√£ xo√° t√†i kho·∫£n');
          renderAccountList();
        }

        if(act === 'openUser'){
          const users = collectFormUsers(body.querySelector('.acc_edit_users'));
          const u = users.find(u=>u.link);
          if(!u || !u.link){
            showToast('Ch∆∞a c√≥ link ng∆∞·ªùi d√πng ƒë·ªÉ m·ªü');
            return;
          }
          let url = u.link.trim();
          if(!/^https?:\/\//i.test(url)){
            url = 'https://' + url;
          }
          window.open(url, '_blank');
        }
      });

      wrap.appendChild(headBtn);
      wrap.appendChild(body);
      acc_list.appendChild(wrap);
    });
  }

  function addUserRowToForm(user){
    acc_usersContainer.appendChild(newUserRow(user));
  }

  function clearAccForm(){
    acc_account.value = '';
    acc_days.value = '';
    acc_usersContainer.innerHTML = '';
  }

  if(acc_addUserBtn){
    acc_addUserBtn.addEventListener('click', ()=>{
      const current = acc_usersContainer.querySelectorAll('.acc-user-row').length;
      if(current >= 3){
        showToast('T·ªëi ƒëa 3 ng∆∞·ªùi d√πng.');
        return;
      }
      addUserRowToForm({});
    });
  }

  if(acc_clearFormBtn){
    acc_clearFormBtn.addEventListener('click', clearAccForm);
  }

  if(acc_saveBtn){
    acc_saveBtn.addEventListener('click', ()=>{
      const name = (acc_account.value || '').trim();
      const days = parseInt(acc_days.value || '0', 10);
      if(!name){
        showToast('T√™n t√†i kho·∫£n kh√¥ng ƒë∆∞·ª£c tr·ªëng.');
        return;
      }
      if(isNaN(days) || days < 0){
        showToast('S·ªë ng√†y kh√¥ng h·ª£p l·ªá.');
        return;
      }
      const users = collectFormUsers(acc_usersContainer);
      const nowTs = Date.now();
      const expiresAt = nowTs + days*24*60*60*1000;
      const id = 'acc_'+nowTs+'_'+Math.random().toString(16).slice(2);
      const obj = {id, account:name, expiresAt, users, status:'active', createdAt:nowTs};
      accData = loadAccounts();
      accData.push(obj);
      saveAccounts();
      showToast('ƒê√£ l∆∞u t√†i kho·∫£n');
      clearAccForm();
      renderAccountList();
    });
  }

  accData = loadAccounts();
  renderAccountList();

  // COUNTDOWN
  setInterval(()=>{
    const items = $$('.acc-head-btn');
    const now = Date.now();
    items.forEach(btn=>{
      const expTs = parseInt(btn.dataset.expTs || 'NaN', 10);
      const cdSpan = btn.querySelector('.acc-countdown');
      if(!cdSpan || !expTs || isNaN(expTs)) return;
      let diff = expTs - now;
      if(diff <= 0){
        cdSpan.textContent = '(0 ng√†y 0 gi·ªù 0 ph√∫t 0 gi√¢y)';
        return;
      }
      let sec = Math.floor(diff/1000);
      const days = Math.floor(sec/86400); sec -= days*86400;
      const hrs = Math.floor(sec/3600); sec -= hrs*3600;
      const mins = Math.floor(sec/60); sec -= mins*60;
      cdSpan.textContent = `(${days} ng√†y ${hrs} gi·ªù ${mins} ph√∫t ${sec} gi√¢y)`;
    });
  }, 1000);

})();
</script>
</body>
</html>
