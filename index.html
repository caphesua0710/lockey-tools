<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TK Suite ‚Äî Mail & Account Tools</title>

<link rel="icon" type="image/png" href="logo.png" />

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
  // Firebase project lockey-238c0
  const firebaseConfig = {
    apiKey: "AIzaSyDiwjp-OoPJ3VwC068gvhTJ3swdjFc8k5A",
    authDomain: "lockey-238c0.firebaseapp.com",
    projectId: "lockey-238c0",
    storageBucket: "lockey-238c0.firebasestorage.app",
    messagingSenderId: "1097009271087",
    appId: "1:1097009271087:web:0f5cd5b55c917bbe21d1da",
    measurementId: "G-PNCE5DYWQK"
  };
</script>

<style>
  :root{
    --green:#22c55e;
    --green-600:#16a34a;
    --green-700:#15803d;
    --green-soft:#dcfce7;

    --bg:#f1f5f9;
    --fg:#0f172a;
    --muted:#6b7280;
    --card:#ffffff;
    --line:#e5e7eb;
    --shadow:0 10px 30px rgba(15,23,42,0.12);

    --radius:16px;
    --danger:#ef4444;
    --danger-soft:#fee2e2;
    --warning:#f97316;
    --warning-soft:#ffedd5;
  }

  body[data-theme="dark"]{
    /* Y√äU C·∫¶U 1: N√¢ng c·∫•p UI Neon */
    --green: #00ff9c; /* Neon Green */
    --green-600: #00e68c;
    --green-700: #00cc7a;
    --green-soft: rgba(0, 255, 156, 0.1);
    --muted: #8892b0;
    
    --bg:#010a1f; /* Dark Neon Blue */
    --fg:#e5e7eb;
    --card:#021027; /* Slightly lighter than bg */
    --line:#0e2240; /* Darker blue line */
    
    --shadow:0 20px 50px rgba(0,0,0,0.9);
    --danger-soft:rgba(248,113,113,0.1);
    --warning-soft:rgba(248,250,252,0.04);
    
    /* Neon specific glows */
    --neon-glow-small: 0 0 4px rgba(0, 255, 156, 0.5);
    --neon-glow-medium: 0 0 8px rgba(0, 255, 156, 0.7);
    --neon-glow-text: 0 0 5px rgba(0, 255, 156, 0.8);
  }

  *{box-sizing:border-box;}
  html,body{height:100%;}
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    background:radial-gradient(circle at top,var(--green-soft) 0,transparent 45%), var(--bg);
    color:var(--fg);
    display:flex;
    justify-content:center;
  }

  .app{
    width:100%;
    max-width:430px;
    padding:16px 12px 24px;
  }

  /* Desktop: n·ªü r·ªông h∆°n cho m√†n to (PC, 27") */
  @media (min-width: 768px){
    .app{
      max-width:900px;
      padding:20px 24px 32px;
    }
  }
  @media (min-width: 1200px){
    .app{
      max-width:1100px;
    }
  }

  /* Header */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
  }
  .topbar-left{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .logo-box{
    width:32px;
    height:32px;
    border-radius:999px;
    overflow:hidden;
    box-shadow:0 6px 14px rgba(0,0,0,0.35);
    border:1px solid rgba(250,250,250,0.6);
    background:radial-gradient(circle at 30% 20%, rgba(250,250,250,0.15), transparent 60%), #020617;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .logo-img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .brand-title{font-size:16px;font-weight:700;}
  .brand-sub{font-size:11px;color:var(--muted);}
  
  /* Y√äU C·∫¶U 1: Th√™m hi·ªáu ·ª©ng neon cho title */
  body[data-theme="dark"] .brand-title{
    color: var(--green);
    text-shadow: var(--neon-glow-text);
  }

  .topbar-actions{
    display:flex;
    align-items:center;
    gap:6px;
  }

  .icon-btn{
    width:32px;
    height:32px;
    border-radius:999px;
    border:1px solid var(--line);
    background:var(--card);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:17px;
    cursor:pointer;
    transition:.15s all ease;
  }
  .icon-btn:hover{border-color:var(--green);}

  .btn{
    appearance:none;
    border-radius:999px;
    border:1px solid transparent;
    background:var(--green);
    color:#fff;
    padding:7px 12px;
    font-size:12px;
    font-weight:600;
    display:inline-flex;
    align-items:center;
    gap:6px;
    cursor:pointer;
    white-space:nowrap;
    transition:.16s transform ease,.16s box-shadow ease,.16s background ease,.16s border-color ease;
  }
  .btn.small{padding:5px 10px;font-size:11px;}
  .btn:active{transform:translateY(1px);}
  .btn.ghost{
    background:var(--card);
    border-color:var(--line);
    color:var(--fg);
  }
  body[data-theme="dark"] .btn.ghost{background:#020617;}
  .btn.danger{
    background:var(--danger-soft);
    border-color:#fecaca;
    color:#b91c1c;
  }
  .btn.full{width:100%;justify-content:center;}
  
  /* Y√äU C·∫¶U 1: Th√™m hi·ªáu ·ª©ng neon cho button */
  body[data-theme="dark"] .btn{
    box-shadow: var(--neon-glow-medium);
    text-shadow: 0 0 2px rgba(0,0,0,0.9);
    border-color: transparent;
  }
  body[data-theme="dark"] .btn:hover{
    transform: scale(1.02);
    box-shadow: 0 0 15px var(--green);
  }
  body[data-theme="dark"] .btn.ghost{
    box-shadow: none; /* Ghost button kh√¥ng c·∫ßn glow */
    text-shadow: none;
    border-color: var(--line);
  }
  body[data-theme="dark"] .btn.ghost:hover{
    transform: none;
    box-shadow: none;
    border-color: var(--green);
  }

  /* Cloud status */
  .cloud-status{
    font-size:10px;
    color:var(--muted);
    padding:2px 6px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(248,250,252,0.8);
  }
  body[data-theme="dark"] .cloud-status{
    background:rgba(15,23,42,0.9);
  }

  /* Tabs ch√≠nh (4 tab) */
  .tabs{
    display:flex;
    gap:6px;
    margin-bottom:10px;
    overflow-x:auto;
    padding-bottom:4px;
  }
  .tab{
    appearance:none;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(248,250,252,0.9);
    padding:6px 10px;
    font-size:11px;
    font-weight:600;
    cursor:pointer;
    white-space:nowrap;
    color:var(--muted);
    display:inline-flex;
    align-items:center;
    gap:5px;
  }
  body[data-theme="dark"] .tab{
    background:rgba(15,23,42,0.9);
  }
  .tab span.idx{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:16px;
    height:16px;
    border-radius:999px;
    background:var(--green-soft);
    font-size:10px;
    color:var(--green-700);
  }
  .tab[aria-selected="true"]{
    color:#fff;
    border-color:transparent;
    background:linear-gradient(135deg,var(--green),var(--green-600));
    box-shadow:0 10px 26px rgba(22,163,74,0.35);
  }
  .tab[aria-selected="true"] span.idx{
    background:rgba(15,23,42,0.15);
    color:#bbf7d0;
  }
  
  /* Y√äU C·∫¶U 1: Th√™m hi·ªáu ·ª©ng neon cho tab active */
  body[data-theme="dark"] .tab[aria-selected="true"]{
     box-shadow: var(--neon-glow-medium);
     border-color: var(--green);
     text-shadow: 0 0 2px rgba(0,0,0,0.9);
  }

  /* Panel: mobile = 1 c·ªôt, desktop = 2 c·ªôt (input | output) */
  .panel{
    display:grid;
    grid-template-columns:minmax(0,1fr);
    gap:10px;
  }
  .panel[hidden]{display:none;}
  @media (min-width: 900px){
    .panel{
      grid-template-columns:minmax(0,1.05fr) minmax(0,1fr);
      align-items:flex-start;
    }
  }

  /* Card chung */
  .card{
    background:var(--card);
    border-radius:var(--radius);
    border:1px solid var(--line);
    box-shadow:var(--shadow);
    margin-bottom:0;
    overflow:hidden;
  }
  /* Y√äU C·∫¶U 1: Th√™m hi·ªáu ·ª©ng neon cho card */
  body[data-theme="dark"] .card{
    transition: border-color .2s ease, box-shadow .2s ease;
  }
  body[data-theme="dark"] .card:hover{
     border-color: rgba(0, 255, 156, 0.3);
     box-shadow: var(--shadow), 0 0 10px rgba(0, 255, 156, 0.2);
  }
  
  .card-head{
    padding:8px 10px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    /* Y√äU C·∫¶U 3: Cho ph√©p wrap v√† ƒë·∫©y toolbar sang ph·∫£i */
    flex-wrap: wrap; 
  }
  .card-head h3{
    margin:0;
    font-size:13px;
    font-weight:700;
    flex-shrink: 0; /* Y√äU C·∫¶U 3 */
  }
  .card-head .badge {
    flex-shrink: 0; /* Y√äU C·∫¶U 3 */
  }
  .card-head .toolbar {
    margin-left: auto; /* Y√äU C·∫¶U 3: ƒê·∫©y toolbar sang ph·∫£i */
  }
  
  .card-body{padding:10px;}

  .badge{
    padding:3px 7px;
    border-radius:999px;
    border:1px solid var(--line);
    font-size:10px;
    color:var(--muted);
    background:rgba(248,250,252,0.9);
  }
  body[data-theme="dark"] .badge{
    background:rgba(15,23,42,0.9);
  }

  .field{margin-bottom:8px;}
  .label{
    font-size:12px;
    font-weight:600;
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:4px;
  }

  textarea,input[type="text"],input[type="number"],input[type="date"]{
    width:100%;
    border-radius:14px;
    border:1px solid var(--line);
    padding:10px 11px;
    font-size:13px;
    font-family:inherit;
    background:var(--card);
    color:var(--fg);
    outline:none;
  }
  textarea::placeholder,input::placeholder{color:rgba(148,163,184,0.8);}
  textarea:focus,input:focus{
    border-color:var(--green);
    box-shadow:0 0 0 1px var(--green-soft);
  }
  /* Y√äU C·∫¶U 1: Th√™m hi·ªáu ·ª©ng neon cho focus */
  body[data-theme="dark"] textarea:focus,
  body[data-theme="dark"] input[type="text"]:focus,
  body[data-theme="dark"] input[type="number"]:focus,
  body[data-theme="dark"] input[type="date"]:focus {
    border-color: var(--green);
    box-shadow: 0 0 0 1px var(--green), var(--neon-glow-small);
  }
  
  textarea{
    min-height:190px;
    resize:vertical;
    line-height:1.45;
  }
  /* Desktop: text area cao h∆°n ch√∫t cho d·ªÖ nh√¨n */
  @media (min-width: 900px){
    textarea{
      min-height:230px;
    }
  }

  .mono{
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  }

  .row{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    align-items:center;
  }
  .toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    /* Y√äU C·∫¶U 3: Xo√° margin-top, set v·ªÅ 0 */
    margin:0; 
  }

  .pill-row{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .pill-column{flex-direction:column;}
  .pill-radio{
    flex:1 1 auto;
    border-radius:999px;
    border:1px solid var(--line);
    padding:7px 9px;
    display:flex;
    align-items:flex-start;
    gap:6px;
    cursor:pointer;
    font-size:11px;
    background:rgba(248,250,252,0.9);
  }
  body[data-theme="dark"] .pill-radio{
    background:rgba(15,23,42,0.9);
  }
  .pill-radio input{
    margin-top:2px;
    accent-color:var(--green);
  }
  .pill-main{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .pill-main strong{font-size:11px;}

  .checkbox-inline{
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-size:11px;
  }
  .checkbox-inline input{accent-color:var(--green);}

  /* History overlay */
  .history-overlay{
    position:fixed;
    inset:0;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:14px 10px;
    opacity:0;
    pointer-events:none;
    transition:.18s opacity ease;
    z-index:50;
  }
  .history-overlay.open{
    opacity:1;
    pointer-events:auto;
  }
  .history-backdrop{
    position:absolute;
    inset:0;
    background:rgba(15,23,42,0.55);
  }
  body[data-theme="dark"] .history-backdrop {
    background: rgba(1, 10, 31, 0.8); /* Darker backdrop for neon */
  }
  .history-sheet{
    position:relative;
    width:100%;
    max-width:430px;
    border-radius:18px;
    border:1px solid var(--line);
    background:var(--card);
    box-shadow:0 22px 50px rgba(0,0,0,0.75);
    max-height:calc(100vh - 40px);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  body[data-theme="dark"] .history-sheet {
    border-color: var(--line);
    box-shadow: 0 22px 50px rgba(0,0,0,0.75), 0 0 15px rgba(0, 255, 156, 0.2);
  }
  @media (min-width:768px){
    .history-sheet{
      max-width:600px;
    }
  }
  .history-header{
    padding:8px 10px 4px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .history-header-title{
    font-size:13px;
    font-weight:700;
  }
  .history-header-sub{
    font-size:11px;
    color:var(--muted);
  }
  .history-actions{
    padding:6px 10px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:6px;
  }
  .history-actions-right{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    justify-content:flex-end;
  }

  .history-list{
    padding:8px 10px 10px;
    overflow:auto;
    flex:1 1 auto;
  }
  .history-empty{
    font-size:12px;
    color:var(--muted);
  }
  .h-item{
    border-radius:14px;
    border:1px solid var(--line);
    margin-bottom:8px;
    overflow:hidden;
    background:rgba(248,250,252,0.9);
  }
  body[data-theme="dark"] .h-item{
    background:rgba(15,23,42,0.95);
  }
  .h-btn{
    width:100%;
    text-align:left;
    border:none;
    background:rgba(236,252,203,0.6);
    padding:7px 9px;
    display:flex;
    align-items:center;
    gap:6px;
    cursor:pointer;
  }
  body[data-theme="dark"] .h-btn{
    background:rgba(22,163,74,0.18);
  }
  .h-main{
    display:flex;
    flex-direction:column;
    gap:2px;
    flex:1;
    min-width:0;
  }
  .h-line1{font-size:12px;font-weight:600;}
  .h-line2{
    font-size:11px;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .h-tag{
    font-size:10px;
    padding:2px 6px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,0.6);
  }
  .h-body{
    display:none;
    padding:8px 9px 9px;
    border-top:1px solid var(--line);
  }
  .h-cols{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .history-ta{
    width:100%;
    min-height:70px;
    resize:vertical;
    border-radius:10px;
    border:1px solid var(--line);
    padding:7px 8px;
    font-size:11px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    background:var(--card);
    color:var(--fg);
  }

  /* Toast */
  #toast{
    position:fixed;
    left:50%;
    bottom:18px;
    transform:translateX(-50%);
    background:var(--green-600);
    color:#fff;
    padding:7px 14px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
    box-shadow:0 12px 30px rgba(22,163,74,0.6);
    opacity:0;
    transition:.18s opacity ease;
    z-index:60;
    pointer-events:none;
  }
  body[data-theme="dark"] #toast {
    background: var(--green);
    color: #010a1f;
    box-shadow: var(--neon-glow-medium);
  }

  /* Account manager */
  .acc-form-actions{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    margin-top:6px;
  }
  .acc-users{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .acc-user-row{
    padding:6px 8px;
    border-radius:12px;
    border:1px dashed var(--line);
  }
  .acc-user-row-title{
    font-size:11px;
    font-weight:600;
    margin-bottom:4px;
  }
  .acc-list-empty{
    font-size:12px;
    color:var(--muted);
  }
  .acc-item{
    border-radius:14px;
    border:1px solid var(--line);
    margin-bottom:8px;
    overflow:hidden;
    background:rgba(248,250,252,0.9);
  }
  body[data-theme="dark"] .acc-item{
    background:rgba(15,23,42,0.95);
  }
  .acc-head-btn{
    width:100%;
    text-align:left;
    border:none;
    background:rgba(226,232,240,0.9);
    padding:8px 9px;
    display:flex;
    align-items:center;
    gap:6px;
    cursor:pointer;
  }
  body[data-theme="dark"] .acc-head-btn{
    background:rgba(15,23,42,0.9);
  }
  .acc-title{
    font-size:12px;
    font-weight:600;
  }
  .acc-sub{
    font-size:11px;
    color:var(--muted);
  }
  .acc-badges{
    margin-left:auto;
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    font-size:10px;
  }
  .acc-badge{
    padding:2px 6px;
    border-radius:999px;
    border:1px solid var(--line);
  }
  .acc-badge-warning{
    background:var(--warning-soft);
    color:var(--warning);
    border-color:#fed7aa;
  }
  .acc-badge-error{
    background:var(--danger-soft);
    color:#b91c1c;
  }
  .acc-badge-expired{
    background:rgba(148,163,184,0.12);
    color:var(--muted);
  }
  .acc-body{
    display:none;
    padding:8px 9px 9px;
    border-top:1px solid var(--line);
  }
  .acc-body-grid{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .acc-body-actions{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:6px;
  }
  .pill-inline{
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-size:11px;
  }
</style>
</head>
<body data-theme="light">
<div class="app">
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo-box">
        <img src="logo.png" alt="Logo" class="logo-img">
      </div>
      <div>
        <div class="brand-title">TK Suite</div>
        <div class="brand-sub">Mail ‚Ä¢ Key ‚Ä¢ T√†i kho·∫£n</div>
      </div>
    </div>
    <div class="topbar-actions">
      <span class="cloud-status" id="cloudStatus">Cloud: ƒëang kh·ªüi t·∫°o‚Ä¶</span>
      <button class="icon-btn" id="btnToggleTheme" title="Ch·∫ø ƒë·ªô t·ªëi / s√°ng">üåô</button>
      <button class="btn ghost small" id="toggleHistoryBtn">L·ªãch s·ª≠</button>
    </div>
  </header>

  <div class="tabs">
    <button class="tab" id="tabAccounts" aria-selected="true"><span class="idx">1</span>T√†i kho·∫£n</button>
    <button class="tab" id="tabCleaner" aria-selected="false"><span class="idx">2</span>Cleaner</button>
    <button class="tab" id="tabScan" aria-selected="false"><span class="idx">3</span>Scan</button>
    <button class="tab" id="tabKey" aria-selected="false"><span class="idx">4</span>Add Link</button>
  </div>

  <section class="panel" id="panelAccounts">
    <div class="card">
      <div class="card-head">
        <h3>Th√™m / s·ª≠a t√†i kho·∫£n</h3>
      </div>
      <div class="card-body">
        <div class="field">
          <div class="label"><span>T√†i kho·∫£n *</span></div>
          <input type="text" id="acc_account" placeholder="Nh·∫≠p t√™n t√†i kho·∫£n..." />
        </div>

        <div class="field">
          <div class="label"><span>S·ªë ng√†y c√≤n *</span></div>
          <input type="number" id="acc_days" min="0" placeholder="VD: 30" />
        </div>

        <div class="field">
          <div class="label">
            <span>Ng∆∞·ªùi d√πng & thi·∫øt b·ªã (t·ªëi ƒëa 3)</span>
          </div>
          <div class="acc-users" id="acc_usersContainer"></div>
          <button class="btn ghost small" id="acc_addUserBtn" style="margin-top:6px;">+ Th√™m ng∆∞·ªùi d√πng</button>
        </div>

        <div class="acc-form-actions">
          <button class="btn full" id="acc_saveBtn">L∆∞u t√†i kho·∫£n</button>
          <button class="btn ghost full" id="acc_clearFormBtn">Xo√° form</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <h3>Danh s√°ch t√†i kho·∫£n</h3>
      </div>
      <div class="card-body" id="acc_list">
        <div class="acc-list-empty">Ch∆∞a c√≥ t√†i kho·∫£n n√†o.</div>
      </div>
    </div>
  </section>
  
  <section class="panel" id="panelCleaner" hidden>
    <div class="card">
      <div class="card-head">
        <h3>Mail Cleaner</h3>
      </div>
      <div class="card-body">
        <div class="field">
          <div class="label">
            <span>Input</span>
            <button class="btn ghost small" id="cl_resetBtn">Reset</button>
          </div>
          <div class="row">
            <label class="btn ghost small" for="cl_fileInput">Ch·ªçn file .txt</label>
            <input id="cl_fileInput" type="file" accept=".txt,text/plain" hidden />
          </div>
        </div>

        <div class="field">
          <textarea id="cl_inputArea" class="mono" placeholder="D√°n danh s√°ch mail ·ªü ƒë√¢y..."></textarea>
        </div>

        <div class="field">
          <div class="row">
            <label class="checkbox-inline">
              <input id="cl_dedupe" type="checkbox" checked />
              <span>Xo√° tr√πng</span>
            </label>
            <label class="checkbox-inline">
              <input id="cl_treatEscapedNewlines" type="checkbox" />
              <span>\\n ‚Üí xu·ªëng d√≤ng</span>
            </label>
          </div>
        </div>

        <div class="field">
          <div class="label"><span>Ki·ªÉu xu·∫•t</span></div>
          <div class="pill-row">
            <label class="pill-radio">
              <input type="radio" name="cl_outMode" value="email" checked />
              <div class="pill-main">
                <strong>Ch·ªâ email</strong>
                <span class="mono" style="font-size:10px;">mail@example.com</span>
              </div>
            </label>
            <label class="pill-radio">
              <input type="radio" name="cl_outMode" value="emailPass" />
              <div class="pill-main">
                <strong>Email | Pass</strong>
                <span class="mono" style="font-size:10px;">mail@example.com|m·∫≠t_kh·∫©u</span>
              </div>
            </label>
          </div>
        </div>

        <button class="btn full" id="cl_processBtn">Process</button>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <h3>K·∫øt qu·∫£</h3>
        <span class="badge" id="cl_statBadge">0 d√≤ng ‚Üí 0 out</span>
        <div class="toolbar">
          <button class="btn ghost small" id="cl_selectBtn">ALL</button>
          <button class="btn ghost small" id="cl_copyBtn">Copy</button>
          <button class="btn ghost small" id="cl_downloadBtn">T·∫£i .txt</button>
          <button class="btn ghost small" id="cl_saveHistoryBtn">L∆∞u</button>
        </div>
      </div>
      <div class="card-body">
        <textarea id="cl_resultTA" class="mono" placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..." readonly></textarea>
        </div>
    </div>
  </section>

  <section class="panel" id="panelScan" hidden>
    <div class="card">
      <div class="card-head">
        <h3>Scan / Format</h3>
      </div>
      <div class="card-body">
        <div class="field">
          <div class="label">
            <span>Input</span>
            <button class="btn ghost small" id="sc_resetBtn">Reset</button>
          </div>
          <div class="row">
            <label class="btn ghost small" for="sc_fileInput">Ch·ªçn file .txt</label>
            <input id="sc_fileInput" type="file" accept=".txt,text/plain" hidden />
          </div>
        </div>

        <div class="field">
          <textarea id="sc_inputArea" class="mono" placeholder="M·ªói d√≤ng 1 mail..."></textarea>
        </div>

        <div class="field">
          <div class="label"><span>Ki·ªÉu format</span></div>
          <div class="pill-row">
            <label class="pill-radio">
              <input type="radio" name="sc_fmt" value="1" checked />
              <div class="pill-main">
                <strong>mail|xincamon</strong>
                <span class="mono" style="font-size:10px;">mail@example.com|xincamon</span>
              </div>
            </label>
            <label class="pill-radio">
              <input type="radio" name="sc_fmt" value="2" />
              <div class="pill-main">
                <strong>T√†i kho·∫£n | M·∫≠t kh·∫©u</strong>
                <span class="mono" style="font-size:10px;">T√†i kho·∫£n:mail|M·∫≠t kh·∫©u:xincamon</span>
              </div>
            </label>
          </div>
        </div>

        <button class="btn full" id="sc_processBtn">Process</button>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <h3>K·∫øt qu·∫£</h3>
        <span class="badge" id="sc_stat">0 d√≤ng</span>
        <div class="toolbar">
          <button class="btn ghost small" id="sc_selectAllOut">ALL</button>
          <button class="btn ghost small" id="sc_copyAllOut">Copy</button>
          <button class="btn ghost small" id="sc_saveHistoryBtn">L∆∞u</button>
        </div>
      </div>
      <div class="card-body">
        <textarea id="sc_resultTA" class="mono" readonly placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."></textarea>
        </div>
    </div>
  </section>

  <section class="panel" id="panelKey" hidden>
    <div class="card">
      <div class="card-head">
        <div class="row" style="justify-content:flex-start;gap:6px;">
          <button class="btn ghost small" id="lk_linkToggleBtn">Link nh·∫≠p key</button>
          <h3>Add Link Nh·∫≠p Key</h3>
        </div>
      </div>
      <div class="card-body">
        <div class="field" id="lk_linkPanel" style="display:none;">
          <div class="label">
            <span>Link nh·∫≠p key</span>
          </div>
          <div class="row" style="width:100%;gap:6px;">
            <input id="lk_linkInput" type="text" placeholder="https://nhapkey.click ho·∫∑c nhapkey.click" />
            <button class="btn ghost small" id="lk_saveLinkBtn">L∆∞u</button>
          </div>
        </div>

        <div class="field">
          <div class="label">
            <span>N·∫°p file key</span>
            <button class="btn ghost small" id="lk_resetBtn">Reset</button>
          </div>
          <div class="row">
            <label class="btn ghost small" for="lk_fileInput">Ch·ªçn file .txt</label>
            <input id="lk_fileInput" type="file" accept=".txt,text/plain" hidden />
          </div>
        </div>

        <div class="field">
          <textarea id="lk_rawInput" class="mono" placeholder="Danh s√°ch key..."></textarea>
        </div>

        <div class="field">
          <div class="label"><span>T√πy ch·ªçn format</span></div>
          <div class="pill-row pill-column">
            <label class="pill-radio" data-option="opt1">
              <input type="radio" name="lk_format" value="opt1" checked />
              <div class="pill-main">
                <strong>T√πy ch·ªçn 1</strong>
                <span class="mono" style="font-size:10px;">KEY:m√£key|link nh·∫≠p key:link</span>
              </div>
            </label>
            <label class="pill-radio" data-option="opt2">
              <input type="radio" name="lk_format" value="opt2" />
              <div class="pill-main">
                <strong>T√πy ch·ªçn 2</strong>
                <span class="mono" style="font-size:10px;">m√£key|link nh·∫≠p key:link</span>
              </div>
            </label>
            <label class="pill-radio" data-option="opt3">
              <input type="radio" name="lk_format" value="opt3" />
              <div class="pill-main">
                <strong>T√πy ch·ªçn 3</strong>
                <span class="mono" style="font-size:10px;">m√£key</span>
              </div>
            </label>
          </div>
        </div>

        <button class="btn full" id="lk_processBtn">Process</button>

        <div class="row" style="margin-top:6px;">
          <span class="badge" id="lk_statLines">0 d√≤ng</span>
          <span class="badge" id="lk_statValid">0 key h·ª£p l·ªá</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <h3>K·∫øt qu·∫£</h3>
        <div class="toolbar">
          <button class="btn ghost small" id="lk_copyBtn">Copy</button>
          <button class="btn ghost small" id="lk_downloadBtn">T·∫£i .txt</button>
          <button class="btn ghost small" id="lk_saveHistoryBtn">L∆∞u</button>
        </div>
      </div>
      <div class="card-body">
        <textarea id="lk_output" class="mono" readonly placeholder="K·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y..."></textarea>
        </div>
    </div>
  </section>

</div>

<div class="history-overlay" id="historyPanel" aria-hidden="true">
  <div class="history-backdrop" id="panelBackdrop"></div>
  <div class="history-sheet">
    <div class="history-header">
      <div>
        <div class="history-header-title">L·ªãch s·ª≠</div>
        <div class="history-header-sub">Theo t·ª´ng tab: Cleaner, Scan, Add Link</div>
      </div>
      <button class="btn ghost small" id="closePanelBtn">ƒê√≥ng</button>
    </div>
    <div class="history-actions">
      <div class="history-actions-right">
        <button class="btn ghost small" id="btnPullCloud">T·∫£i t·ª´ cloud</button>
        <button class="btn ghost small" id="btnPushCloud">ƒê·ªìng b·ªô l√™n cloud</button>
        <button class="btn danger small" id="clearHistoryBtn">Xo√° l·ªãch s·ª≠ tab hi·ªán t·∫°i</button>
      </div>
    </div>
    <div class="history-list" id="historyList"></div>
  </div>
</div>

<div id="toast"></div>

<script>
(function(){
  const $ = s=>document.querySelector(s);

  /* ===== FIREBASE (HISTORY + ACCOUNTS) ===== */
  let db = null;
  let firebaseReady = false;
  const cloudStatusEl = document.getElementById('cloudStatus');

  async function initFirebase(){
    try{
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: ƒëang k·∫øt n·ªëi‚Ä¶';
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      await firebase.auth().signInAnonymously();
      firebaseReady = true;
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: OK';
    }catch(e){
      console.warn('Firebase init failed', e);
      firebaseReady = false;
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: l·ªói init';
    }
  }
  const getHistoryDocRef = () => db.collection('lockey_suite').doc('history');

  async function syncHistoryFromCloud(){
    if(!firebaseReady || !db){
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: ch∆∞a s·∫µn s√†ng';
      return;
    }
    try{
      const snap = await getHistoryDocRef().get();
      if(snap.exists){
        const data = snap.data() || {};
        const map = {
          cleaner: data.cleaner || [],
          scan: data.scan || [],
          key: data.key || [],
          accounts: data.accounts || []
        };
        saveHistoryMap(map);
        if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: OK';
      }else{
        if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: OK (ch∆∞a c√≥ l·ªãch s·ª≠)';
      }
    }catch(e){
      console.warn('syncHistoryFromCloud error', e);
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: l·ªói ƒë·ªçc l·ªãch s·ª≠';
    }
  }

  async function syncHistoryToCloud(){
    if(!firebaseReady || !db){
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: ch∆∞a s·∫µn s√†ng';
      return;
    }
    try{
      const map = loadHistoryMap();
      await getHistoryDocRef().set(map);
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: OK';
    }catch(e){
      console.warn('syncHistoryToCloud error', e);
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: l·ªói ghi l·ªãch s·ª≠';
    }
  }

  /* ===== FIRESTORE: ACCOUNTS ===== */
  const ACC_COLLECTION = 'tk_manager';

  async function fetchAccountsFromCloud(){
    if(!firebaseReady || !db) return null;
    try{
      const snap = await db.collection(ACC_COLLECTION).get();
      const arr = [];
      snap.forEach(doc=>arr.push(doc.data()));
      return arr;
    }catch(e){
      console.warn('fetchAccountsFromCloud error', e);
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: l·ªói ƒë·ªçc t√†i kho·∫£n';
      return null;
    }
  }

  async function upsertAccountCloud(accObj){
    if(!firebaseReady || !db || !accObj || !accObj.id) return;
    try{
      await db.collection(ACC_COLLECTION).doc(accObj.id).set(accObj);
    }catch(e){
      console.warn('upsertAccountCloud error', e);
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: l·ªói ghi t√†i kho·∫£n';
    }
  }

  async function deleteAccountCloud(accId){
    if(!firebaseReady || !db || !accId) return;
    try{
      await db.collection(ACC_COLLECTION).doc(accId).delete();
    }catch(e){
      console.warn('deleteAccountCloud error', e);
      if(cloudStatusEl) cloudStatusEl.textContent = 'Cloud: l·ªói xo√° t√†i kho·∫£n';
    }
  }

  async function initAccountsFromCloud(){
    let cloudAcc = null;
    if(firebaseReady && db){
      cloudAcc = await fetchAccountsFromCloud();
    }
    if(cloudAcc && cloudAcc.length){
      accData = cloudAcc;
      saveAccounts();
    }else{
      accData = loadAccounts();
    }
    cleanupAndRenderAccounts();
  }

  /* ===== DOM ELEMENTS ===== */
  const els = {
    tabCleaner: $('#tabCleaner'),
    tabScan: $('#tabScan'),
    tabKey: $('#tabKey'),
    tabAccounts: $('#tabAccounts'),
    panelCleaner: $('#panelCleaner'),
    panelScan: $('#panelScan'),
    panelKey: $('#panelKey'),
    panelAccounts: $('#panelAccounts'),
    btnToggleTheme: $('#btnToggleTheme'),
    historyPanel: $('#historyPanel'),
    panelBackdrop: $('#panelBackdrop'),
    historyList: $('#historyList'),
    toggleHistoryBtn: $('#toggleHistoryBtn'),
    closePanelBtn: $('#closePanelBtn'),
    clearHistoryBtn: $('#clearHistoryBtn'),
    historyHeaderTitle: document.querySelector('.history-header-title'),
    historyHeaderSub: document.querySelector('.history-header-sub'),
    btnPullCloud: $('#btnPullCloud'),
    btnPushCloud: $('#btnPushCloud')
  };

  const LS_HISTORY = 'multiToolHistory_v3';
  const LS_THEME = 'multiToolTheme_v1';
  const LS_LINK = 'nk_link_v2';
  const LS_ACC = 'tk_accounts_v1';
  const LS_TAB = 'multiToolTab_v1'; // Y√äU C·∫¶U 5: Th√™m key l∆∞u tab

  let currentTab = 'accounts'; // Y√äU C·∫¶U 2: ƒê·ªïi tab m·∫∑c ƒë·ªãnh

  /* ===== TOAST ===== */
  function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.opacity = '1';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>{ t.style.opacity='0'; }, 1500);
  }

  async function syncFromCloudUI(){
    await syncHistoryFromCloud();
    renderHistory();
    showToast('ƒê√£ t·∫£i l·ªãch s·ª≠ t·ª´ cloud');
  }
  async function syncToCloudUI(){
    await syncHistoryToCloud();
    showToast('ƒê√£ ƒë·ªìng b·ªô l·ªãch s·ª≠ l√™n cloud');
  }

  /* ===== CLIPBOARD ===== */
  async function copyToClipboard(text){
    if(!text){
      showToast('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ copy.');
      return false;
    }
    try{
      await navigator.clipboard.writeText(text);
      showToast('ƒê√£ copy v√†o clipboard.');
      return true;
    }catch(e){
      try{
        const ta=document.createElement('textarea');
        ta.value=text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('ƒê√£ copy.');
        return true;
      }catch(e2){
        showToast('Copy th·∫•t b·∫°i.');
        return false;
      }
    }
  }

  /* ===== THEME ===== */
  function applyTheme(theme){
    const body = document.body;
    body.setAttribute('data-theme', theme);
    if(theme === 'dark'){
      els.btnToggleTheme.textContent = '‚òÄÔ∏è';
      els.btnToggleTheme.title = 'Ch·∫ø ƒë·ªô s√°ng';
    }else{
      els.btnToggleTheme.textContent = 'üåô';
      els.btnToggleTheme.title = 'Ch·∫ø ƒë·ªô t·ªëi';
    }
    localStorage.setItem(LS_THEME, theme);
  }
  function initTheme(){
    const saved = localStorage.getItem(LS_THEME);
    applyTheme(saved === 'dark' ? 'dark' : 'light');
  }
  els.btnToggleTheme.addEventListener('click', ()=>{
    const cur = document.body.getAttribute('data-theme') || 'light';
    applyTheme(cur === 'light' ? 'dark' : 'light');
  });

  /* ===== HISTORY MAP (3 tab mail/key + accounts placeholder) ===== */
  function defaultHistoryMap(){
    return { cleaner:[], scan:[], key:[], accounts:[] };
  }
  function loadHistoryMap(){
    try{
      const raw = localStorage.getItem(LS_HISTORY);
      if(!raw) return defaultHistoryMap();
      const data = JSON.parse(raw);
      return {
        cleaner: data.cleaner || [],
        scan: data.scan || [],
        key: data.key || [],
        accounts: data.accounts || []
      };
    }catch(e){
      return defaultHistoryMap();
    }
  }
  function saveHistoryMap(map){
    localStorage.setItem(LS_HISTORY, JSON.stringify(map));
  }
  function toolLabel(tab){
    if(tab === 'cleaner') return 'Cleaner';
    if(tab === 'scan') return 'Scan';
    if(tab === 'key') return 'Add Link';
    if(tab === 'accounts') return 'T√†i kho·∫£n';
    return tab;
  }
  function two(n){return String(n).padStart(2,'0');}
  function tsLabel(ts){
    const d=new Date(ts);
    return `${two(d.getDate())}-${two(d.getMonth()+1)}-${d.getFullYear()} ${two(d.getHours())}:${two(d.getMinutes())}:${two(d.getSeconds())}`;
  }

  function addHistoryItemForTab(tab, partial){
    const map = loadHistoryMap();
    const now = Date.now();
    const entry = Object.assign({
      id: `${now}_${Math.random().toString(36).slice(2)}`,
      tool: toolLabel(tab),
      ts: now
    }, partial);
    map[tab] = map[tab] || [];
    map[tab].unshift(entry);
    saveHistoryMap(map);
    syncHistoryToCloud();
    if(currentTab === tab) renderHistory();
  }

  function deleteHistoryItemForTab(tab,id){
    const map = loadHistoryMap();
    map[tab] = (map[tab] || []).filter(x=>x.id !== id);
    saveHistoryMap(map);
    syncHistoryToCloud();
    if(currentTab === tab) renderHistory();
  }

  function clearHistoryForTab(tab){
    const map = loadHistoryMap();
    map[tab] = [];
    saveHistoryMap(map);
    syncHistoryToCloud();
    if(currentTab === tab) renderHistory();
  }

  function openHistoryPanel(){
    els.historyPanel.classList.add('open');
    els.historyPanel.setAttribute('aria-hidden','false');
    renderHistory();
  }
  function closeHistoryPanel(){
    els.historyPanel.classList.remove('open');
    els.historyPanel.setAttribute('aria-hidden','true');
  }

  els.toggleHistoryBtn.addEventListener('click', ()=>{
    const open = els.historyPanel.classList.contains('open');
    open ? closeHistoryPanel() : openHistoryPanel();
  });
  els.closePanelBtn.addEventListener('click', closeHistoryPanel);
  els.panelBackdrop.addEventListener('click', closeHistoryPanel);
  document.addEventListener('keydown', e=>{ if(e.key === 'Escape') closeHistoryPanel(); });

  els.clearHistoryBtn.addEventListener('click', ()=>{
    if(currentTab === 'accounts'){
      showToast('L·ªãch s·ª≠ hi·ªán ch·ªâ √°p d·ª•ng cho 3 tab Mail/Key.');
      return;
    }
    if(confirm('Xo√° to√†n b·ªô l·ªãch s·ª≠ c·ªßa tab hi·ªán t·∫°i?')){
      clearHistoryForTab(currentTab);
      showToast('ƒê√£ xo√° l·ªãch s·ª≠ tab n√†y.');
    }
  });
  els.btnPullCloud.addEventListener('click', syncFromCloudUI);
  els.btnPushCloud.addEventListener('click', syncToCloudUI);

  function renderHistory(){
    const map = loadHistoryMap();
    const list = map[currentTab] || [];
    els.historyHeaderTitle.textContent = 'L·ªãch s·ª≠ - ' + toolLabel(currentTab);
    els.historyHeaderSub.textContent = (currentTab === 'accounts')
      ? 'T·∫°m th·ªùi ch∆∞a d√πng l·ªãch s·ª≠ cho tab T√†i kho·∫£n'
      : 'C√°c l√¥ ƒë√£ l∆∞u c·ªßa ' + toolLabel(currentTab);

    els.historyList.innerHTML = '';
    if(currentTab === 'accounts'){
      const dv = document.createElement('div');
      dv.className='history-empty';
      dv.textContent='Tab T√†i kho·∫£n kh√¥ng d√πng l·ªãch s·ª≠ l√¥. 3 tab Mail/Key v·∫´n d√πng b√¨nh th∆∞·ªùng.';
      els.historyList.appendChild(dv);
      return;
    }

    if(!list.length){
      const dv = document.createElement('div');
      dv.className='history-empty';
      dv.textContent='Ch∆∞a c√≥ l√¥ n√†o.';
      els.historyList.appendChild(dv);
      return;
    }
    list.forEach(it=>{
      const wrap = document.createElement('div');
      wrap.className='h-item';
      wrap.dataset.id = it.id;

      const btn = document.createElement('button');
      btn.type='button';
      btn.className='h-btn';
      btn.innerHTML = `
        <div class="h-main">
          <div class="h-line1">${tsLabel(it.ts)} ‚Ä¢ ${toolLabel(currentTab)}</div>
          <div class="h-line2">${it.inCount||0} ‚Üí ${it.outCount||0} d√≤ng${it.meta ? ' ‚Ä¢ '+it.meta : ''}</div>
        </div>
        <span class="h-tag">${toolLabel(currentTab)}</span>
      `;

      const body = document.createElement('div');
      body.className='h-body';
      body.innerHTML = `
        <div class="h-cols">
          <div>
            <textarea class="history-ta" readonly>${it.input||''}</textarea>
          </div>
          <div>
            <textarea class="history-ta" readonly>${it.output||''}</textarea>
          </div>
        </div>
        <div class="toolbar" style="margin-top:8px;">
          <button class="btn ghost small" data-act="copy-in">Copy Input</button>
          <button class="btn ghost small" data-act="copy-out">Copy Output</button>
          <button class="btn ghost small" data-act="load">N·∫°p v√†o tab</button>
          <button class="btn danger small" data-act="delete">Xo√° l√¥</button>
          <span class="cloud-status" style="margin-left:auto;">${tsLabel(it.ts)}</span>
        </div>
      `;

      btn.addEventListener('click', ()=>{
        const open = body.style.display === 'block';
        body.style.display = open ? 'none' : 'block';
      });

      body.addEventListener('click', async e=>{
        const b = e.target.closest('button[data-act]');
        if(!b) return;
        const act = b.dataset.act;
        const mapNow = loadHistoryMap();
        const listNow = mapNow[currentTab] || [];
        const found = listNow.find(x=>x.id === it.id);
        if(!found) return;

        if(act === 'copy-in') await copyToClipboard(found.input||'');
        if(act === 'copy-out') await copyToClipboard(found.output||'');

        if(act === 'load'){
          if(currentTab === 'cleaner'){
            cl.area.value = found.input || '';
            window.scrollTo({top:0,behavior:'smooth'});
          }else if(currentTab === 'scan'){
            sc.input.value = found.input || '';
            window.scrollTo({top:0,behavior:'smooth'});
          }else if(currentTab === 'key'){
            lk.rawInput.value = found.input || '';
            window.scrollTo({top:0,behavior:'smooth'});
          }
        }
        if(act === 'delete'){
          if(confirm('Xo√° l√¥ n√†y?')) deleteHistoryItemForTab(currentTab, found.id);
        }
      });

      wrap.appendChild(btn);
      wrap.appendChild(body);
      els.historyList.appendChild(wrap);
    });
  }

  /* ===== TABS ===== */
  function activateTab(name){
    // Y√äU C·∫¶U 5: L∆∞u tab v√†o localStorage
    localStorage.setItem(LS_TAB, name);
    
    currentTab = name;
    const mapping = {
      cleaner: {tab: els.tabCleaner, panel: els.panelCleaner},
      scan: {tab: els.tabScan, panel: els.panelScan},
      key: {tab: els.tabKey, panel: els.panelKey},
      accounts: {tab: els.tabAccounts, panel: els.panelAccounts}
    };
    Object.keys(mapping).forEach(k=>{
      const {tab,panel} = mapping[k];
      const active = (k === name);
      tab.setAttribute('aria-selected', String(active));
      panel.hidden = !active;
    });
    if(els.historyPanel.classList.contains('open')) renderHistory();
  }

  els.tabCleaner.addEventListener('click', ()=>activateTab('cleaner'));
  els.tabScan.addEventListener('click', ()=>activateTab('scan'));
  els.tabKey.addEventListener('click', ()=>activateTab('key'));
  els.tabAccounts.addEventListener('click', ()=>activateTab('accounts'));

  /* ===== TOOL 1: CLEANER ===== */
  function normalizeAndSplit(rawText, treatEscaped){
    if(typeof rawText !== 'string') return [];
    let s = rawText.replace(/\r/g,'');
    if(treatEscaped){
      s = s.replace(/\\n/g,'\n').replace(/\\r/g,'\n');
    }
    s = s.replace(/[;,]+/g,'\n');
    s = s.replace(/\n+/g,'\n');
    return s.split('\n');
  }
  function parseEmailAndPassword(line){
    const parts = line.split('|').map(p=>p.trim());
    const firstPart = (parts[0] || '').split(/\s+/)[0];
    const secondPart = parts.length>1 ? parts[1] : null;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(emailRegex.test(firstPart)){
      return {email:firstPart.toLowerCase(), password:(secondPart ?? '')};
    }
    const m = line.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    if(m) return {email:m[0].toLowerCase(), password:null};
    return {email:null, password:null};
  }
  function extractEmailOnly(line){
    let s = line;
    const pipeIndex = s.indexOf('|');
    if(pipeIndex !== -1){
      s = s.slice(0, pipeIndex);
    }
    s = s.trim().split(/\s+/)[0];
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(emailRegex.test(s)) return s.toLowerCase();
    const m = line.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    return m ? m[0].toLowerCase() : null;
  }
  function getCleanerMode(){
    const r = document.querySelector('input[name="cl_outMode"]:checked');
    return r ? r.value : 'email';
  }

  const cl = {
    file: $('#cl_fileInput'),
    reset: $('#cl_resetBtn'),
    area: $('#cl_inputArea'),
    dedupe: $('#cl_dedupe'),
    treat: $('#cl_treatEscapedNewlines'),
    process: $('#cl_processBtn'),
    download: $('#cl_downloadBtn'),
    copy: $('#cl_copyBtn'),
    select: $('#cl_selectBtn'),
    stat: $('#cl_statBadge'),
    result: $('#cl_resultTA'),
    saveHistory: $('#cl_saveHistoryBtn')
  };
  let clBlob = null;
  let clText = '';

  function clSetOutput(text){
    clText = text || '';
    cl.result.value = clText || '';
    const has = !!clText;
    cl.download.disabled = !has;
    cl.copy.disabled = !has;
    cl.select.disabled = !has;
    cl.saveHistory.disabled = !has;
  }
  function clUpdateStat(inCount, outCount){
    cl.stat.textContent = `${inCount} d√≤ng ‚Üí ${outCount} out`;
  }

  cl.file.addEventListener('change', e=>{
    const f = e.target.files && e.target.files[0];
    if(!f){ return; }
    const r = new FileReader();
    r.onload = ()=>{ cl.area.value = r.result; };
    r.readAsText(f);
  });
  cl.reset.addEventListener('click', ()=>{
    cl.file.value = '';
    cl.area.value = '';
    clSetOutput('');
    clUpdateStat(0,0);
  });

  cl.process.addEventListener('click', ()=>{
    const raw = cl.area.value || '';
    const dedupe = cl.dedupe.checked;
    const treat = cl.treat.checked;
    const mode = getCleanerMode();
    const lines = normalizeAndSplit(raw, treat);
    const seen = new Set();
    const out = [];

    for(let rawLine of lines){
      const line = rawLine.trim();
      if(!line) continue;
      if(mode === 'email'){
        const email = extractEmailOnly(line);
        if(!email) continue;
        if(dedupe && seen.has(email)) continue;
        seen.add(email);
        out.push(email);
      }else{
        const {email,password} = parseEmailAndPassword(line);
        if(!email) continue;
        const key = email + '|' + (password || '');
        if(dedupe && seen.has(key)) continue;
        seen.add(key);
        if(password !== null && password !== ''){
          out.push(`${email}|${password}`);
        }else{
          out.push(email);
        }
      }
    }

    const cleaned = out.join('\n');
    clSetOutput(cleaned);
    clUpdateStat(lines.filter(l=>l.trim()).length, out.length);

    if(cleaned){
      clBlob = new Blob([cleaned], {type:'text/plain;charset=utf-8'});
    }else{
      clBlob = null;
    }

    showToast(out.length ? `ƒê√£ x·ª≠ l√Ω ${out.length} d√≤ng` : 'Kh√¥ng t√¨m th·∫•y email h·ª£p l·ªá.');
  });

  cl.select.addEventListener('click', ()=>{
    cl.result.focus();
    cl.result.select();
    cl.result.setSelectionRange(0, cl.result.value.length);
  });
  cl.copy.addEventListener('click', ()=>{ if(clText) copyToClipboard(clText); });
  cl.download.addEventListener('click', ()=>{
    if(!clBlob){ showToast('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i.'); return; }
    const url = URL.createObjectURL(clBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cleaner_${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  cl.saveHistory.addEventListener('click', ()=>{
    const text = clText.trim();
    if(!text){
      showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ L∆∞u.');
      return;
    }
    const raw = cl.area.value || '';
    const lines = normalizeAndSplit(raw, cl.treat.checked);
    const inCount = lines.filter(l=>l.trim()).length;
    const outCount = text.split('\n').filter(l=>l.trim()).length;
    addHistoryItemForTab('cleaner', {
      inCount,
      outCount,
      input: raw,
      output: text,
      meta: getCleanerMode() + (cl.dedupe.checked ? ' ‚Ä¢ dedupe' : '')
    });
    showToast('ƒê√£ l∆∞u v√†o l·ªãch s·ª≠.');
  });

  /* ===== TOOL 2: SCAN / FORMAT ===== */
  function scGetFmt(){
    const r = document.querySelector('input[name="sc_fmt"]:checked');
    return r ? r.value : '1';
  }
  function scParseInput(text){
    return (text || '')
      .split(/\r?\n/)
      .map(s=>s.trim())
      .filter(Boolean)
      .map(line=>{
        let s = line;
        const pipeIndex = s.indexOf('|');
        if(pipeIndex !== -1){
          s = s.slice(0, pipeIndex);
        }
        s = s.trim().split(/\s+/)[0];
        return s;
      })
      .filter(Boolean);
  }
  function scBuildLines(emails){
    const fmt = scGetFmt();
    return emails.map(email => {
      if(fmt === '2'){
        return `T√†i kho·∫£n:${email}|M·∫≠t kh·∫©u:xincamon`;
      }
      return `${email}|xincamon`;
    });
  }

  const sc = {
    file: $('#sc_fileInput'),
    reset: $('#sc_resetBtn'),
    saveHistoryBtn: $('#sc_saveHistoryBtn'),
    input: $('#sc_inputArea'),
    process: $('#sc_processBtn'),
    selectAll: $('#sc_selectAllOut'),
    copyAll: $('#sc_copyAllOut'),
    stat: $('#sc_stat'),
    result: $('#sc_resultTA')
  };

  function scProcessOnly(){
    const emails = scParseInput(sc.input.value);
    const out = scBuildLines(emails);
    sc.result.value = out.join('\n');
    sc.stat.textContent = `${emails.length} d√≤ng`;
    showToast(emails.length ? `ƒê√£ x·ª≠ l√Ω ${emails.length} mail` : 'Kh√¥ng c√≥ d√≤ng n√†o.');
    return {emails, out};
  }

  sc.file.addEventListener('change', e=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{ sc.input.value = r.result; };
    r.readAsText(f);
  });

  sc.reset.addEventListener('click', ()=>{
    sc.file.value = '';
    sc.input.value = '';
    sc.result.value = '';
    sc.stat.textContent = '0 d√≤ng';
  });

  sc.process.addEventListener('click', ()=>{ scProcessOnly(); });

  sc.selectAll.addEventListener('click', ()=>{
    sc.result.focus();
    sc.result.select();
    sc.result.setSelectionRange(0, sc.result.value.length);
  });

  sc.copyAll.addEventListener('click', async ()=>{
    const text = sc.result.value;
    await copyToClipboard(text);
  });

  sc.saveHistoryBtn.addEventListener('click', ()=>{
    const {emails,out} = scProcessOnly();
    if(!out.length){
      showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u.');
      return;
    }
    addHistoryItemForTab('scan', {
      inCount:emails.length,
      outCount:out.length,
      input:sc.input.value || '',
      output:out.join('\n'),
      meta:`fmt:${scGetFmt()}`
    });
    showToast('ƒê√£ l∆∞u v√†o l·ªãch s·ª≠.');
  });

  /* ===== TOOL 3: ADD LINK KEY ===== */
  function lkCleanLink(v){
    if(!v) return '';
    let s = v.trim();
    s = s.replace(/^link\s*nh·∫≠p\s*key\s*:/i,'').trim();
    return s;
  }

  function lkExtractKey(line){
    if(!line) return null;
    let s = line.trim();
    if(!s) return null;

    const keyMarker = s.match(/Key\s*:\s*([^|]+)(?:\|.*)?$/i);
    if(keyMarker){
      return keyMarker[1].trim();
    }
    const pipeIndex = s.indexOf('|');
    if(pipeIndex !== -1){
      s = s.slice(0, pipeIndex);
    }
    s = s.trim();
    if(/^[A-Za-z0-9][A-Za-z0-9\-\._]{1,}$/.test(s)){
      return s;
    }
    return null;
  }

  function lkParseInput(raw){
    const lines = (raw || '').split(/\r?\n/);
    const keys = [];
    let total = 0;
    for(const ln of lines){
      if(!ln.trim()) continue;
      total++;
      const k = lkExtractKey(ln);
      if(k) keys.push(k);
    }
    return {keys,total};
  }

  function lkBuildAll(keys, linkRaw){
    const linkPart = linkRaw !== '' ? `|link nh·∫≠p key:${linkRaw}` : `|link nh·∫≠p key:`;
    const opt1 = keys.map(k=>`KEY:${k}${linkPart}`).join('\n');
    const opt2 = keys.map(k=>`${k}${linkPart}`).join('\n');
    const opt3 = keys.join('\n');
    return {opt1,opt2,opt3};
  }

  function lkCurrentOption(){
    const r = document.querySelector('input[name="lk_format"]:checked');
    return r ? r.value : 'opt1';
  }

  const lk = {
    linkToggleBtn: $('#lk_linkToggleBtn'),
    linkPanel: $('#lk_linkPanel'),
    linkInput: $('#lk_linkInput'),
    saveLinkBtn: $('#lk_saveLinkBtn'),
    fileInput: $('#lk_fileInput'),
    resetBtn: $('#lk_resetBtn'),
    rawInput: $('#lk_rawInput'),
    statLines: $('#lk_statLines'),
    statValid: $('#lk_statValid'),
    processBtn: $('#lk_processBtn'),
    output: $('#lk_output'),
    copyBtn: $('#lk_copyBtn'),
    downloadBtn: $('#lk_downloadBtn'),
    saveHistoryBtn: $('#lk_saveHistoryBtn'),
    formatPills: Array.from(document.querySelectorAll('label.pill-radio[data-option]'))
  };

  const lkState = {
    opt1:'',opt2:'',opt3:'',keysCount:0,linkRaw:''
  };

  lk.linkToggleBtn.addEventListener('click', ()=>{
    const visible = lk.linkPanel.style.display === 'block';
    lk.linkPanel.style.display = visible ? 'none' : 'block';
  });

  function lkUpdateStats(total, valid){
    lk.statLines.textContent = `${total} d√≤ng`;
    lk.statValid.textContent = `${valid} key h·ª£p l·ªá`;
  }
  function lkUpdateOutput(){
    const opt = lkCurrentOption();
    const text = opt === 'opt2' ? lkState.opt2 : opt === 'opt3' ? lkState.opt3 : lkState.opt1;
    lk.output.value = text || '';
  }

  lk.saveLinkBtn.addEventListener('click', ()=>{
    const linkRaw = lkCleanLink(lk.linkInput.value);
    lk.linkInput.value = linkRaw;
    localStorage.setItem(LS_LINK, linkRaw);
    lk.linkPanel.style.display = 'none';
    showToast('ƒê√£ l∆∞u link nh·∫≠p key.');
  });

  lk.fileInput.addEventListener('change', async ()=>{
    const file = lk.fileInput.files && lk.fileInput.files[0];
    if(!file) return;
    const text = await file.text();
    const cur = (lk.rawInput.value || '').trim();
    lk.rawInput.value = cur ? (cur + '\n' + text.trim()) : text.trim();
    const {keys,total} = lkParseInput(lk.rawInput.value);
    lkUpdateStats(total, keys.length);
    showToast('ƒê√£ n·∫°p n·ªôi dung t·ª´ file.');
  });

  lk.resetBtn.addEventListener('click', ()=>{
    lk.fileInput.value = '';
    lk.rawInput.value = '';
    lkUpdateStats(0,0);
    lk.output.value = '';
  });

  lk.rawInput.addEventListener('input', ()=>{
    const {keys,total} = lkParseInput(lk.rawInput.value);
    lkUpdateStats(total, keys.length);
  });

  lk.formatPills.forEach(pill=>{
    pill.addEventListener('click', ()=>{
      const input = pill.querySelector('input[type="radio"]');
      if(input){
        input.checked = true;
        lkUpdateOutput();
      }
    });
  });

  lk.processBtn.addEventListener('click', ()=>{
    const linkRaw = lkCleanLink(lk.linkInput.value);
    const {keys,total} = lkParseInput(lk.rawInput.value);
    lkUpdateStats(total, keys.length);
    const {opt1,opt2,opt3} = lkBuildAll(keys, linkRaw);
    lkState.opt1 = opt1;
    lkState.opt2 = opt2;
    lkState.opt3 = opt3;
    lkState.keysCount = keys.length;
    lkState.linkRaw = linkRaw;
    lkUpdateOutput();
    localStorage.setItem(LS_LINK, linkRaw);

    if(!keys.length){
      showToast('Kh√¥ng t√¨m th·∫•y key h·ª£p l·ªá.');
    }else{
      showToast(`ƒê√£ x·ª≠ l√Ω ${keys.length} key.`);
    }
  });

  lk.copyBtn.addEventListener('click', ()=>{
    copyToClipboard(lk.output.value.trim());
  });

  lk.downloadBtn.addEventListener('click', ()=>{
    const text = lk.output.value.trim();
    if(!text){
      showToast('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i.');
      return;
    }
    const opt = lkCurrentOption();
    const suffix = opt === 'opt2' ? 'option2' : opt === 'opt3' ? 'option3' : 'option1';
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `keys_${suffix}_${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  lk.saveHistoryBtn.addEventListener('click', ()=>{
    const text = lk.output.value.trim();
    if(!text){
      showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ L∆∞u.');
      return;
    }
    const {keys,total} = lkParseInput(lk.rawInput.value);
    const opt = lkCurrentOption();
    addHistoryItemForTab('key', {
      inCount: total,
      outCount: keys.length || text.split('\n').filter(Boolean).length,
      input: lk.rawInput.value || '',
      output: text,
      meta:`format:${opt}`
    });
    showToast('ƒê√£ l∆∞u v√†o l·ªãch s·ª≠.');
  });

  /* ===== TOOL 4: QU·∫¢N L√ù T√ÄI KHO·∫¢N (LOCALSTORAGE + FIREBASE) ===== */
  const acc = {
    account: $('#acc_account'),
    days: $('#acc_days'),
    usersContainer: $('#acc_usersContainer'),
    addUserBtn: $('#acc_addUserBtn'),
    saveBtn: $('#acc_saveBtn'),
    clearFormBtn: $('#acc_clearFormBtn'),
    list: $('#acc_list')
  };

  let accData = []; // m·∫£ng t√†i kho·∫£n
  const ONE_DAY = 24*60*60*1000;

  function loadAccounts(){
    try{
      const raw = localStorage.getItem(LS_ACC);
      if(!raw) return [];
      return JSON.parse(raw);
    }catch(e){
      return [];
    }
  }
  function saveAccounts(){
    localStorage.setItem(LS_ACC, JSON.stringify(accData));
  }

  function newUserRow(initial){
    const div = document.createElement('div');
    div.className = 'acc-user-row';
    div.innerHTML = `
      <div class="acc-user-row-title">Ng∆∞·ªùi d√πng</div>
      <div class="field" style="margin-bottom:4px;">
        <input type="text" class="acc_user_name" placeholder="T√™n ng∆∞·ªùi d√πng" value="${initial?.name||''}">
      </div>
      <div class="field" style="margin-bottom:4px;">
        <input type="text" class="acc_user_link" placeholder="Link ng∆∞·ªùi d√πng (tu·ª≥ ch·ªçn)" value="${initial?.link||''}">
      </div>
      <div class="field" style="margin-bottom:0;">
        <input type="text" class="acc_user_device" placeholder="Thi·∫øt b·ªã (tu·ª≥ ch·ªçn)" value="${initial?.device||''}">
      </div>
    `;
    return div;
  }

  function resetAccForm(){
    acc.account.value = '';
    acc.days.value = '';
    acc.usersContainer.innerHTML = '';
    acc.usersContainer.appendChild(newUserRow());
  }

  function collectFormUsers(container){
    const rows = container.querySelectorAll('.acc-user-row');
    const users = [];
    rows.forEach(row=>{
      const name = row.querySelector('.acc_user_name').value.trim();
      const link = row.querySelector('.acc_user_link').value.trim();
      const device = row.querySelector('.acc_user_device').value.trim();
      if(name || link || device){
        users.push({name,link,device});
      }
    });
    return users;
  }

  acc.addUserBtn.addEventListener('click', ()=>{
    const current = acc.usersContainer.querySelectorAll('.acc-user-row').length;
    if(current >= 3){
      showToast('T·ªëi ƒëa 3 ng∆∞·ªùi d√πng cho 1 t√†i kho·∫£n.');
      return;
    }
    acc.usersContainer.appendChild(newUserRow());
  });

  acc.clearFormBtn.addEventListener('click', resetAccForm);

  acc.saveBtn.addEventListener('click', async ()=>{
    const accountName = acc.account.value.trim();
    const days = parseInt(acc.days.value, 10);
    if(!accountName){
      showToast('Vui l√≤ng nh·∫≠p t√™n t√†i kho·∫£n.');
      return;
    }
    if(isNaN(days) || days < 0){
      showToast('S·ªë ng√†y kh√¥ng h·ª£p l·ªá.');
      return;
    }
    const users = collectFormUsers(acc.usersContainer);
    const now = Date.now();
    const expiry = now + days*ONE_DAY;

    const existingIndex = accData.findIndex(a=>a.account === accountName);
    let targetIndex;

    if(existingIndex >= 0){
      const old = accData[existingIndex];
      accData[existingIndex] = {
        ...old,
        account: accountName,
        totalDays: days,
        updatedAt: now,
        expiry,
        status: old.status === 'error' ? 'error' : 'active',
        users
      };
      targetIndex = existingIndex;
      showToast('ƒê√£ c·∫≠p nh·∫≠t t√†i kho·∫£n.');
    }else{
      const id = `${now}_${Math.random().toString(36).slice(2)}`;
      accData.unshift({
        id,
        account: accountName,
        totalDays: days,
        createdAt: now,
        updatedAt: now,
        expiry,
        status: 'active',   // active | warning | expired | error
        errorDate: null,
        daysLeftAtError: null,
        warnMutedUntil: null,
        users
      });
      targetIndex = 0;
      showToast('ƒê√£ th√™m t√†i kho·∫£n.');
    }

    saveAccounts();
    await upsertAccountCloud(accData[targetIndex]);
    cleanupAndRenderAccounts();
    resetAccForm();
  });

  function calcDaysLeft(accObj){
    const now = Date.now();
    const diff = accObj.expiry - now;
    return Math.ceil(diff / ONE_DAY);
  }

  async function cleanupAndRenderAccounts(){
    const now = Date.now();
    const next = [];
    for(const a of accData){
      let keep = true;
      if(a.status === 'error' && a.errorDate){
        if(now - a.errorDate > 3*ONE_DAY){
          keep = false; // xo√° 3 ng√†y sau l·ªói
          await deleteAccountCloud(a.id);
        }
      }else{
        const daysLeft = calcDaysLeft(a);
        if(daysLeft < -3){
          keep = false; // xo√° sau 3 ng√†y h·∫øt h·∫°n
          await deleteAccountCloud(a.id);
        }
      }
      if(keep) next.push(a);
    }
    accData = next;
    saveAccounts();
    renderAccounts();
  }

  function renderAccounts(){
    acc.list.innerHTML = '';
    if(!accData.length){
      const dv = document.createElement('div');
      dv.className='acc-list-empty';
      dv.textContent='Ch∆∞a c√≥ t√†i kho·∫£n n√†o.';
      acc.list.appendChild(dv);
      return;
    }
    const now = Date.now();

    accData.forEach(item=>{
      const daysLeft = calcDaysLeft(item);
      let status = item.status || 'active';
      if(status !== 'error'){
        if(daysLeft <= 0) status = 'expired';
        else if(daysLeft <= 2) status = 'warning';
        else status = 'active';
        item.status = status;
      }

      const wrap = document.createElement('div');
      wrap.className = 'acc-item';
      wrap.dataset.id = item.id;

      const headBtn = document.createElement('button');
      headBtn.type='button';
      headBtn.className='acc-head-btn';
      headBtn.innerHTML = `
        <div>
          <div class="acc-title">${item.account}</div>
          <div class="acc-sub">
            ${status === 'error'
              ? `L·ªói ‚Ä¢ c√≤n ${item.daysLeftAtError ?? daysLeft} ng√†y l√∫c l·ªói`
              : daysLeft > 0
                ? `C√≤n ${daysLeft} ng√†y`
                : daysLeft === 0
                  ? 'H√¥m nay h·∫øt h·∫°n'
                  : `H·∫øt h·∫°n ${Math.abs(daysLeft)} ng√†y`}
          </div>
        </div>
        <div class="acc-badges">
          ${status === 'warning' ? '<span class="acc-badge acc-badge-warning">S·∫Øp h·∫øt h·∫°n</span>' : ''}
          ${status === 'error' ? '<span class="acc-badge acc-badge-error">L·ªói</span>' : ''}
          ${status === 'expired' && status !== 'error' ? '<span class="acc-badge acc-badge-expired">H·∫øt h·∫°n</span>' : ''}
        </div>
      `;

      const body = document.createElement('div');
      body.className = 'acc-body';

      // Y√äU C·∫¶U 4: Th√™m n√∫t "M·ªü" v√†o v√≤ng l·∫∑p user
      const usersHTML = (item.users || []).map((u,idx)=>`
        <div class="acc-user-row">
          <div class="acc-user-row-title">Ng∆∞·ªùi d√πng ${idx+1}</div>
          <div class="field" style="margin-bottom:4px;">
            <input type="text" class="acc_user_name" placeholder="T√™n ng∆∞·ªùi d√πng" value="${u.name||''}">
          </div>
          <div class="field" style="margin-bottom:4px;">
            <div class="row" style="gap:4px;">
              <input type="text" class="acc_user_link" placeholder="Link ng∆∞·ªùi d√πng (tu·ª≥ ch·ªçn)" value="${u.link||''}" style="flex:1;">
              ${u.link ? `<a href="${u.link.startsWith('http') ? u.link : '//' + u.link}" target="_blank" rel="noopener noreferrer" class="btn ghost small" style="padding:7px 8px;" title="M·ªü link">M·ªü</a>` : ''}
            </div>
          </div>
          <div class="field" style="margin-bottom:0;">
            <input type="text" class="acc_user_device" placeholder="Thi·∫øt b·ªã (tu·ª≥ ch·ªçn)" value="${u.device||''}">
          </div>
        </div>
      `).join('');

      body.innerHTML = `
        <div class="acc-body-grid">
          <div class="field">
            <div class="label"><span>T√†i kho·∫£n</span></div>
            <input type="text" class="acc_edit_account" value="${item.account}" />
          </div>
          <div class="field">
            <div class="label"><span>S·ªë ng√†y c√≤n</span></div>
            <input type="number" class="acc_edit_days" min="0" value="${Math.max(daysLeft,0)}" />
          </div>
          <div class="field">
            <div class="label"><span>Ng∆∞·ªùi d√πng & thi·∫øt b·ªã</span></div>
            <div class="acc-users acc_edit_users">
              ${usersHTML || '<div class="acc-list-empty" style="margin-bottom:4px;">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o.</div>'}
            </div>
            <button class="btn ghost small" data-act="addUser">+ Th√™m ng∆∞·ªùi d√πng</button>
          </div>
          ${status === 'warning' && (!item.warnMutedUntil || now > item.warnMutedUntil)
            ? `<div class="field">
                 <label class="pill-inline">
                   <input type="checkbox" data-act="muteWarning">
                   <span>·∫®n c·∫£nh b√°o 24h cho t√†i kho·∫£n n√†y</span>
                 </label>
               </div>`
            : ''}
        </div>
        <div class="acc-body-actions">
          <button class="btn ghost small" data-act="save">L∆∞u</button>
          <button class="btn danger small" data-act="error">ƒê√°nh d·∫•u l·ªói</button>
          <button class="btn danger small" data-act="delete">Xo√°</button>
        </div>
      `;

      headBtn.addEventListener('click', ()=>{
        const open = body.style.display === 'block';
        body.style.display = open ? 'none' : 'block';
      });

      body.addEventListener('click', async e=>{
        const btn = e.target.closest('button[data-act]');
        // B·ªè qua n·∫øu click v√†o link (Y√äU C·∫¶U 4)
        if (e.target.closest('a[target="_blank"]')) {
          return;
        }
        
        if(!btn) return;
        const act = btn.dataset.act;
        const accId = item.id;
        const index = accData.findIndex(a=>a.id === accId);
        if(index < 0) return;

        if(act === 'addUser'){
          const container = body.querySelector('.acc_edit_users');
          const current = container.querySelectorAll('.acc-user-row').length;
          if(current >= 3){
            showToast('T·ªëi ƒëa 3 ng∆∞·ªùi d√πng.');
            return;
          }
          container.appendChild(newUserRow());
        }

        if(act === 'save'){
          const nameInput = body.querySelector('.acc_edit_account');
          const daysInput = body.querySelector('.acc_edit_days');
          const name = nameInput.value.trim();
          const days = parseInt(daysInput.value,10);
          if(!name){
            showToast('T√™n t√†i kho·∫£n kh√¥ng ƒë∆∞·ª£c tr·ªëng.');
            return;
          }
          if(isNaN(days) || days < 0){
            showToast('S·ªë ng√†y kh√¥ng h·ª£p l·ªá.');
            return;
          }

          const users = collectFormUsers(body.querySelector('.acc_edit_users'));

          const now2 = Date.now();
          accData[index] = {
            ...accData[index],
            account: name,
            totalDays: days,
            updatedAt: now2,
            expiry: now2 + days*ONE_DAY,
            status: accData[index].status === 'error' ? 'error' : 'active',
            users
          };
          saveAccounts();
          await upsertAccountCloud(accData[index]);
          cleanupAndRenderAccounts();
          showToast('ƒê√£ l∆∞u thay ƒë·ªïi.');
        }

        if(act === 'error'){
          if(!confirm('B·∫°n c√≥ ch·∫Øc t√†i kho·∫£n n√†y ƒë√£ l·ªói?')) return;
          const daysLeftNow = calcDaysLeft(accData[index]);
          accData[index].status = 'error';
          accData[index].errorDate = Date.now();
          accData[index].daysLeftAtError = daysLeftNow;
          saveAccounts();
          await upsertAccountCloud(accData[index]);
          cleanupAndRenderAccounts();
          showToast('ƒê√£ ƒë√°nh d·∫•u l·ªói.');
        }

        if(act === 'delete'){
          if(!confirm('Xo√° t√†i kho·∫£n n√†y?')) return;
          const toDel = accData[index];
          accData.splice(index,1);
          saveAccounts();
          await deleteAccountCloud(toDel.id);
          cleanupAndRenderAccounts();
          showToast('ƒê√£ xo√° t√†i kho·∫£n.');
        }
      });

      const muteCheckbox = body.querySelector('input[data-act="muteWarning"]');
      if(muteCheckbox){
        muteCheckbox.addEventListener('change', async ()=>{
          if(muteCheckbox.checked){
            const idx = accData.findIndex(a=>a.id === item.id);
            if(idx >= 0){
              accData[idx].warnMutedUntil = Date.now() + ONE_DAY;
              saveAccounts();
              await upsertAccountCloud(accData[idx]);
              showToast('ƒê√£ ·∫©n c·∫£nh b√°o 24h.');
              cleanupAndRenderAccounts();
            }
          }
        });
      }

      wrap.appendChild(headBtn);
      wrap.appendChild(body);
      acc.list.appendChild(wrap);
    });
  }

  /* ===== INIT ===== */
  (async function init(){
    initTheme();
    await initFirebase();
    await syncHistoryFromCloud();
    
    // Y√äU C·∫¶U 5: ƒê·ªçc tab t·ª´ localStorage
    const savedTab = localStorage.getItem(LS_TAB);
    const validTabs = ['accounts', 'cleaner', 'scan', 'key'];
    const tabToLoad = validTabs.includes(savedTab) ? savedTab : 'accounts'; // M·∫∑c ƒë·ªãnh l√† 'accounts'
    activateTab(tabToLoad);

    renderHistory();

    const savedLink = localStorage.getItem(LS_LINK);
    if(savedLink){
      lk.linkInput.value = savedLink;
    }
    clSetOutput('');

    await initAccountsFromCloud();

    // n·∫øu form tr·ªëng th√¨ t·∫°o 1 user row m·∫∑c ƒë·ªãnh
    if(!acc.usersContainer.querySelector('.acc-user-row')){
      acc.usersContainer.appendChild(newUserRow());
    }

    // c·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥ tr·∫°ng th√°i t√†i kho·∫£n (auto xo√° / c·∫£nh b√°o)
    setInterval(cleanupAndRenderAccounts, 60*1000);
  })();

})();
</script>
</body>
</html>
